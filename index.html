<!-- file: frontend/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

  <title>VoiceSafe ‚Äì AI Voice Scam Detection</title>
  <meta name="description" content="Detect AI voice cloning and impersonation scams instantly. Upload or record audio and analyze scam risk in seconds." />

  <!-- OpenGraph / Twitter -->
  <meta property="og:title" content="VoiceSafe ‚Äì AI Voice Scam Detection" />
  <meta property="og:description" content="Upload or record a voice message and detect impersonation, AI cloning and scam risk instantly." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://voicesafe.ai" />
  <meta property="og:image" content="/og-image.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="VoiceSafe ‚Äì AI Voice Scam Detection" />
  <meta name="twitter:description" content="Analyze voice recordings and detect impersonation or AI scam risk instantly." />
  <meta name="twitter:image" content="/og-image.png" />

  <!-- Favicons / PWA -->
  <link rel="icon" href="/favicon.png" type="image/png" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <link rel="manifest" href="/manifest.webmanifest" />

  <!-- Tailwind (prototype OK) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1220;
      --stroke:rgba(255,255,255,.10);
      --gold1:#F7D774;
      --gold2:#C9A24A;
      --muted:rgba(255,255,255,.72);
      --shadow:0 20px 60px rgba(0,0,0,.45);
    }
    html,body{height:100%}
    body{
      background:
        radial-gradient(1000px 600px at 15% 10%, rgba(247,215,116,.12), transparent 60%),
        radial-gradient(900px 600px at 85% 0%, rgba(201,162,74,.10), transparent 60%),
        radial-gradient(900px 700px at 50% 100%, rgba(99,102,241,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:#fff;
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }
    *{box-sizing:border-box}
    .glass{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }
    .gold-border{
      border:1px solid rgba(247,215,116,.32);
      box-shadow:0 0 0 1px rgba(201,162,74,.18) inset;
    }
    .gold-text{
      background:linear-gradient(90deg, var(--gold1), var(--gold2));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .muted{color:var(--muted)}
    .chip{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
    }
    .btn-gold{
      background:linear-gradient(90deg, rgba(247,215,116,1), rgba(201,162,74,1));
      color:#111827;
      box-shadow:0 10px 30px rgba(247,215,116,.16);
      transition:transform .12s ease, filter .12s ease;
    }
    .btn-gold:hover{filter:brightness(1.03); transform:translateY(-1px)}
    .btn-gold:active{transform:translateY(0)}
    .btn-gold:disabled{opacity:.45; cursor:not-allowed; box-shadow:none; transform:none}
    .bar{
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .bar>div{
      height:100%;
      border-radius:999px;
      background:linear-gradient(90deg, rgba(247,215,116,1), rgba(201,162,74,1));
      width:0%;
      transition:width .35s ease;
    }
    .mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    .safe-pb{padding-bottom:env(safe-area-inset-bottom)}
    .focus-ring:focus{outline:none; box-shadow:0 0 0 3px rgba(247,215,116,.25)}
  </style>
</head>

<body class="min-h-screen safe-pb">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-8 sm:py-10">

    <!-- Top strip -->
    <div class="flex items-center justify-between gap-3 mb-6">
      <div class="inline-flex items-center gap-2 chip px-3 py-1.5 rounded-full text-xs">
        <i class="fa-solid fa-shield-halved"></i>
        <span class="opacity-90">Public Beta</span>
        <span class="opacity-40">‚Ä¢</span>
        <span class="opacity-80"><span id="waitlistCountBadge">0</span> early access sign-ups</span>
      </div>

      <div class="hidden sm:flex items-center gap-2 text-xs muted">
        <span id="liveActivity"></span>
      </div>
    </div>

    <!-- HERO -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-6 items-stretch">
      <div class="lg:col-span-7 glass gold-border rounded-3xl p-6 sm:p-8">
        <div class="flex flex-wrap items-center gap-2">
          <span class="chip rounded-full px-3 py-1 text-xs">
            <i class="fa-solid fa-bolt mr-1"></i> Instant risk report
          </span>
          <span class="chip rounded-full px-3 py-1 text-xs">
            <i class="fa-solid fa-lock mr-1"></i> Privacy-first
          </span>
          <span class="chip rounded-full px-3 py-1 text-xs">
            <i class="fa-solid fa-globe mr-1"></i> Built for global anti-scam
          </span>
        </div>

        <h1 class="mt-5 text-3xl sm:text-4xl md:text-5xl font-extrabold leading-tight">
          <span class="gold-text">VoiceSafe</span>
          <span class="block mt-2">
            Detect AI voice scams <span class="gold-text">before you send money</span>
          </span>
        </h1>

        <p class="mt-4 text-base sm:text-lg muted max-w-2xl">
          Upload or record a short clip. VoiceSafe returns a clear, investor-grade risk report
          (scam score, AI voice probability, stress signals, and key red flags).
        </p>

        <div class="mt-6 flex flex-wrap gap-3">
          <button id="ctaAnalyze" class="btn-gold rounded-xl px-5 py-3 text-sm font-extrabold">
            <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Analyze now
          </button>
          <button id="ctaDemo" class="chip rounded-xl px-5 py-3 text-sm font-semibold hover:opacity-90">
            <i class="fa-solid fa-play mr-2"></i>Try demo result
          </button>
          <button id="ctaHow" class="chip rounded-xl px-5 py-3 text-sm font-semibold hover:opacity-90">
            <i class="fa-solid fa-circle-info mr-2"></i>How it works
          </button>
        </div>

        <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm">
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Free analyses</div>
            <div class="mt-1 text-xl font-bold">3</div>
            <div class="mt-1 text-xs muted">No signup required</div>
          </div>
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Privacy</div>
            <div class="mt-1 text-xl font-bold">No voice storage</div>
            <div class="mt-1 text-xs muted">Prototype mode</div>
          </div>
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Compliance-ready</div>
            <div class="mt-1 text-xl font-bold">GDPR</div>
            <div class="mt-1 text-xs muted">EU-first posture</div>
          </div>
        </div>

        <div class="mt-6 text-xs muted">
          Early access sign-ups: <span id="waitlistCountTop" class="text-white/90 font-semibold">0</span>
          <span class="opacity-40">‚Ä¢</span>
          <span id="waitlistUrgency">Early access is open now.</span>
        </div>
      </div>

      <!-- Backend status -->
      <div class="lg:col-span-5 glass gold-border rounded-3xl p-6 sm:p-7">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="text-sm font-semibold">Backend status</div>
            <div class="text-xs muted truncate mt-1" id="backendStatus">Checking‚Ä¶</div>
          </div>
          <div class="text-right shrink-0">
            <div class="text-xs muted">Mode</div>
            <div class="text-sm font-semibold gold-text" id="modeLabel">PROD</div>
          </div>
        </div>

        <div class="mt-3 text-xs muted break-all">
          <span class="mono" id="backendUrl"></span>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="btnProd" class="chip rounded-xl px-3 py-2 text-xs font-semibold w-1/2 hover:opacity-90">PROD</button>
          <button id="btnLocal" class="chip rounded-xl px-3 py-2 text-xs font-semibold w-1/2 hover:opacity-90">LOCAL</button>
        </div>

        <div class="mt-2 text-[11px] muted">
          Tip: Use LOCAL only when your backend runs on <span class="mono">http://127.0.0.1:10000</span>.
        </div>

        <div class="mt-6 grid grid-cols-1 gap-3">
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">What VoiceSafe looks for</div>
            <div class="mt-2 flex flex-wrap gap-2 text-xs">
              <span class="chip rounded-full px-3 py-1">AI voice patterns</span>
              <span class="chip rounded-full px-3 py-1">Impersonation markers</span>
              <span class="chip rounded-full px-3 py-1">Urgency / pressure</span>
              <span class="chip rounded-full px-3 py-1">Financial request signals</span>
            </div>
          </div>

          <button id="joinWaitlistBtn" class="chip rounded-2xl p-4 text-left hover:opacity-90">
            <div class="text-sm font-semibold">
              <i class="fa-solid fa-fire mr-2"></i>Join early access
            </div>
            <div class="mt-1 text-xs muted">
              Helps prioritize features and shows demand to investors.
            </div>
          </button>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div id="analyzer" class="mt-6 sm:mt-8 grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-6 items-start">
      <!-- LEFT: Analyzer -->
      <div class="lg:col-span-5 glass rounded-3xl p-5 sm:p-6">
        <h2 class="text-lg font-semibold">Analyze a sample</h2>
        <p class="muted text-sm mt-1">Upload audio/video or record a short clip.</p>

        <div class="mt-5">
          <label class="block text-sm muted mb-2" for="fileInput">Upload file</label>
          <input id="fileInput" type="file" accept="audio/*,video/*"
                 class="w-full text-sm chip rounded-xl p-3 outline-none focus-ring" />
          <div class="mt-2 text-xs muted" id="fileHint">No file selected.</div>
        </div>

        <div class="mt-5 grid grid-cols-2 gap-3">
          <button id="recordBtn" type="button"
                  class="chip rounded-xl px-4 py-3 text-sm font-semibold hover:opacity-90">
            <i class="fa-solid fa-microphone mr-2"></i>Record
          </button>

          <button id="analyzeBtn"
                  class="btn-gold rounded-xl px-4 py-3 text-sm font-extrabold">
            <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Analyze
          </button>
          <button id="demoBtn" class="chip rounded-xl px-4 py-3 text-sm font-semibold hover:opacity-90">
  ‚ö° Run Live Demo
</button>
        </div>

        <div class="mt-4 text-xs muted">
          Free 3 analyses ‚Ä¢ No signup required ‚Ä¢ Privacy-first
          <div class="mt-2 leading-6">
            üîí No voice data stored (prototype)<br/>
            ‚ö° Instant risk assessment<br/>
            üá™üá∫ GDPR-ready posture
          </div>
        </div>

        <div class="mt-6 border-t border-white/10 pt-5">
          <h3 class="text-sm font-semibold">Case details (optional)</h3>
          <p class="muted text-xs mt-1">Saved cases can be searched & shared (if backend supports it).</p>
          <div class="mt-4 space-y-3">
            <input id="title" class="w-full chip rounded-xl p-3 text-sm outline-none focus-ring"
                   placeholder="Title (e.g. Telegram investor)" />
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <input id="platform" class="w-full chip rounded-xl p-3 text-sm outline-none focus-ring"
                     placeholder="Platform (Telegram)" />
              <input id="country" class="w-full chip rounded-xl p-3 text-sm outline-none focus-ring"
                     placeholder="Country (US)" />
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <input id="language" class="w-full chip rounded-xl p-3 text-sm outline-none focus-ring"
                     placeholder="Language (EN)" />
              <input id="tags" class="w-full chip rounded-xl p-3 text-sm outline-none focus-ring"
                     placeholder="Tags (comma separated)" />
            </div>
            <textarea id="notes" rows="3"
                      class="w-full chip rounded-xl p-3 text-sm outline-none focus-ring"
                      placeholder="Notes (what happened)"></textarea>
          </div>
          <div class="mt-4 text-xs muted">
            Tip: Keep personal data out of notes.
          </div>
        </div>

        <div class="mt-5 chip rounded-2xl p-4 text-xs muted">
          <div class="font-semibold text-white/90">Disclaimer</div>
          <div class="mt-1">
            Scores are prototypes and can be wrong. Always verify identity using official channels.
          </div>
        </div>
      </div>

      <!-- RIGHT: Results -->
      <div id="resultsCard" class="lg:col-span-7 glass rounded-3xl p-5 sm:p-6">
        <div class="text-xs muted tracking-widest uppercase">AI Risk Assessment Report</div>

        <div class="mt-2 flex flex-col md:flex-row md:items-start md:justify-between gap-4">
          <div class="min-w-0">
            <h2 class="text-2xl font-extrabold">Results</h2>
            <p class="muted text-sm mt-1">Risk signals, explanation and summary.</p>
          </div>

          <div class="flex items-center gap-2 flex-wrap">
            <button id="copyJsonBtn" class="chip rounded-xl px-4 py-2 text-sm font-semibold hover:opacity-90">
              <i class="fa-regular fa-copy mr-2"></i>Copy JSON
            </button>

            <button id="shareBtn" class="chip rounded-xl px-4 py-2 text-sm font-semibold hover:opacity-90" disabled>
              <i class="fa-solid fa-link mr-2"></i>Share
            </button>

            <button id="upgradeBtn" class="btn-gold rounded-xl px-4 py-2 text-sm font-extrabold">
              üöÄ Unlock Pro ‚Äì ‚Ç¨9/month
            </button>

            <button id="manageSubBtn" class="chip rounded-xl px-4 py-2 text-sm hover:opacity-90">
              Manage subscription
            </button>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Scam score</div>
            <div class="mt-1 text-3xl font-extrabold"><span id="scamScore">‚Äî</span><span class="text-base muted">%</span></div>
            <div class="mt-3 bar"><div id="scamBar"></div></div>
          </div>

          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">AI voice probability</div>
            <div class="mt-1 text-3xl font-extrabold"><span id="aiProb">‚Äî</span><span class="text-base muted">%</span></div>
            <div class="mt-3 bar"><div id="aiBar"></div></div>
          </div>

          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Stress level</div>
            <div class="mt-1 text-3xl font-extrabold"><span id="stressLevel">‚Äî</span><span class="text-base muted">%</span></div>
            <div class="mt-3 bar"><div id="stressBar"></div></div>
          </div>
        </div>
<div class="mt-6 glass rounded-2xl p-5 text-sm opacity-90">
  <div class="font-semibold mb-2">Security & Compliance</div>
  <div class="space-y-1 text-xs opacity-80">
    <div>üîí No voice recordings stored permanently</div>
    <div>üõ° GDPR-ready data handling</div>
    <div>‚öñ AI risk scoring is advisory only</div>
    <div>üåç Designed for global fraud prevention use</div>
  </div>
</div>
        <div class="mt-5 chip rounded-2xl p-5">
          <div class="text-xs muted">Summary</div>
          <div class="mt-2 text-slate-100 text-sm sm:text-base" id="summaryText">
            Upload or record a sample to see results.
          </div>
          <div class="mt-3 flex flex-wrap gap-2" id="flagsWrap"></div>
        </div>

        <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="chip rounded-2xl p-5">
            <div class="text-sm font-semibold">Saved case</div>
            <div class="mt-2 text-xs muted">Case ID</div>
            <div class="mt-1 mono text-sm break-all" id="caseId">‚Äî</div>
            <div class="mt-3 text-xs muted" id="caseSavedHint">Analyze a sample to create a case.</div>
          </div>

          <div class="chip rounded-2xl p-5">
            <div class="text-sm font-semibold">Search cases</div>
            <div class="mt-3 flex gap-2">
              <input id="searchQ" class="flex-1 chip rounded-xl p-3 text-sm outline-none focus-ring min-w-0"
                     placeholder="Search title / notes..." />
              <button id="searchBtn" class="btn-gold rounded-xl px-4 py-3 text-sm font-extrabold shrink-0">
                Search
              </button>
            </div>
            <div class="mt-3 flex gap-2">
              <input id="searchTag" class="flex-1 chip rounded-xl p-3 text-sm outline-none focus-ring min-w-0"
                     placeholder="Tag filter (optional)" />
              <button id="clearBtn" class="chip rounded-xl px-4 py-3 text-sm font-semibold hover:opacity-90 shrink-0">
                Clear
              </button>
            </div>
            <div class="mt-4 pr-1 overflow-auto" id="resultsList" style="max-height:min(46vh,360px);"></div>
          </div>
        </div>

        <pre class="mt-5 chip rounded-2xl p-4 text-xs overflow-auto hidden" id="rawJson" style="max-height:min(40vh,320px);"></pre>
      </div>
    </div>

    <div class="mt-10 text-center text-xs muted">
      VoiceSafe ‚Ä¢ Prototype ‚Ä¢ Built for global anti-scam awareness ‚Ä¢ <span class="mono">voicesafe.ai</span>
    </div>
  </div>

  <!-- HOW IT WORKS MODAL -->
  <div id="howModal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div id="howBackdrop" class="absolute inset-0 bg-black/60"></div>
    <div class="relative w-[92%] max-w-2xl rounded-3xl border border-white/10 bg-[#0b0f14] p-6 sm:p-7 shadow-xl">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-xl font-extrabold">How VoiceSafe works</h3>
          <p class="mt-1 text-sm muted">Clear output, fast workflow, minimal friction.</p>
        </div>
        <button id="howClose" class="rounded-xl px-3 py-2 text-sm chip hover:opacity-90">‚úï</button>
      </div>

      <div class="mt-5 grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm">
        <div class="chip rounded-2xl p-4">
          <div class="text-xs muted">1) Input</div>
          <div class="mt-1 font-semibold">Upload or record</div>
          <div class="mt-1 text-xs muted">Audio/video supported</div>
        </div>
        <div class="chip rounded-2xl p-4">
          <div class="text-xs muted">2) Analysis</div>
          <div class="mt-1 font-semibold">AI risk scoring</div>
          <div class="mt-1 text-xs muted">Signals + probabilities</div>
        </div>
        <div class="chip rounded-2xl p-4">
          <div class="text-xs muted">3) Action</div>
          <div class="mt-1 font-semibold">Share & investigate</div>
          <div class="mt-1 text-xs muted">Use official channels</div>
        </div>
      </div>

      <div class="mt-5 text-sm muted leading-6">
        VoiceSafe is a prototype. Scores can be wrong ‚Äî treat the report as an early warning system.
        When money is involved, always verify the caller via trusted, official contact methods.
      </div>

      <div class="mt-6 flex flex-col sm:flex-row gap-2">
        <button id="howTryDemo" class="btn-gold rounded-xl px-4 py-3 text-sm font-extrabold w-full sm:w-auto">
          <i class="fa-solid fa-play mr-2"></i>Load demo result
        </button>
        <button id="howGoAnalyze" class="chip rounded-xl px-4 py-3 text-sm font-semibold hover:opacity-90 w-full sm:w-auto">
          <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Go to analyzer
        </button>
      </div>
    </div>
  </div>

  <!-- PAYWALL MODAL -->
  <div id="paywallModal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div id="paywallBackdrop" class="absolute inset-0 bg-black/60"></div>
    <div class="relative w-[92%] max-w-lg rounded-3xl border border-white/10 bg-[#0b0f14] p-6 shadow-xl">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-xl font-extrabold">Free limit reached</h3>
          <p class="mt-1 text-sm muted">Upgrade to Pro to continue analyzing.</p>
        </div>
        <button id="paywallClose" class="rounded-xl px-3 py-2 text-sm chip hover:opacity-90">‚úï</button>
      </div>

      <div class="mt-4 grid gap-2 text-sm opacity-90">
        <div>‚úì Unlimited analyses</div>
        <div>‚úì Priority processing</div>
        <div>‚úì Case history & sharing</div>
      </div>

      <div class="mt-6 flex flex-col gap-2">
        <button id="paywallCta" class="btn-gold rounded-xl px-4 py-3 text-sm font-extrabold w-full">
          Start Pro ‚Äì ‚Ç¨9/month
        </button>

        <button id="paywallWaitlist" class="chip rounded-xl px-4 py-3 text-sm font-semibold hover:opacity-90 w-full">
          Join early access
        </button>

        <p class="mt-2 text-xs muted">Payment coming soon (prototype). Button can be used to measure demand.</p>
        <p id="waitlistCountText" class="mt-1 text-xs muted text-center"></p>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden z-[60]">
    <div class="chip gold-border rounded-2xl px-4 py-3 text-sm shadow-xl">
      <span id="toastMsg"></span>
    </div>
  </div>

  <script>
    // ===========================
    // CONFIG
    // ===========================
    const URLS = {
      PROD: "https://voicesafe-backend-1.onrender.com",
      LOCAL: "http://127.0.0.1:10000",
    };

    // Stripe links (KEEP CLEAN: no markdown []())
    const STRIPE_CHECKOUT_URL = "https://buy.stripe.com/aFa3cn42A8Iq1cC8m2gA800";
    // Optional: If you have a real Stripe Billing Portal URL, put it here. Otherwise it will just show a message.
    const STRIPE_BILLING_PORTAL_URL = ""; // e.g. "https://billing.stripe.com/p/login/..."

    let backendBase = URLS.PROD;

// DOM helper GLOBAL
const $ = (id) => document.getElementById(id);

const fileInput = $("fileInput");
const analyzeBtn = $("analyzeBtn");
const demoBtn = $("demoBtn");
const recordBtn = $("recordBtn");
const fileHint = $("fileHint");

    // ===========================
    // DOM helpers
    // ===========================
    

    const scamScoreEl = $("scamScore");
    const aiProbEl = $("aiProb");
    const stressLevelEl = $("stressLevel");

    const summaryText = $("summaryText");
    const flagsWrap = $("flagsWrap");
    const rawJson = $("rawJson");

    const scamBar = $("scamBar");
    const aiBar = $("aiBar");
    const stressBar = $("stressBar");

    const copyJsonBtn = $("copyJsonBtn");
    const shareBtn = $("shareBtn");
    const upgradeBtn = $("upgradeBtn");
    const manageSubBtn = $("manageSubBtn");

    const caseIdEl = $("caseId");
    const caseSavedHint = $("caseSavedHint");

    const searchQ = $("searchQ");
    const searchTag = $("searchTag");
    const searchBtn = $("searchBtn");
    const clearBtn = $("clearBtn");
    const resultsList = $("resultsList");

    const titleEl = $("title");
    const platformEl = $("platform");
    const countryEl = $("country");
    const languageEl = $("language");
    const tagsEl = $("tags");
    const notesEl = $("notes");

    const btnProd = $("btnProd");
    const btnLocal = $("btnLocal");

    const ctaAnalyze = $("ctaAnalyze");
    const ctaDemo = $("ctaDemo");
    const ctaHow = $("ctaHow");
    const joinWaitlistBtn = $("joinWaitlistBtn");

    // State
    let lastResponse = null;
    let lastCaseId = null;
    let progressInterval = null;

    // ===========================
    // Small UX helpers
    // ===========================
    function toast(msg) {
      const t = $("toast");
      const m = $("toastMsg");
      if (!t || !m) return;
      m.textContent = msg;
      t.classList.remove("hidden");
      clearTimeout(toast._timer);
      toast._timer = setTimeout(() => t.classList.add("hidden"), 2200);
    }

    function clampPct(v) {
      const n = Number(v);
      if (!Number.isFinite(n)) return 0;
      return Math.max(0, Math.min(100, n));
    }

    function setBars(scam, ai, stress) {
      scamBar.style.width = clampPct(scam) + "%";
      aiBar.style.width = clampPct(ai) + "%";
      stressBar.style.width = clampPct(stress) + "%";
    }

    function normalizeFlags(flags) {
      if (!flags) return [];
      if (Array.isArray(flags)) return flags.filter(Boolean).slice(0, 10);
      if (typeof flags === "string") {
        return flags.split(",").map(s => s.trim()).filter(Boolean).slice(0, 10);
      }
      return [];
    }

    function pickNumber(obj, keys, fallback = null) {
      for (const k of keys) {
        if (obj && obj[k] !== undefined && obj[k] !== null && obj[k] !== "") {
          const n = Number(obj[k]);
          if (Number.isFinite(n)) return n;
        }
      }
      return fallback;
    }

    function pickText(obj, keys, fallback = "") {
      for (const k of keys) {
        if (obj && typeof obj[k] === "string" && obj[k].trim()) return obj[k].trim();
      }
      return fallback;
    }

    function scrollToResults() {
      const el = $("resultsCard");
      if (!el) return;
      try {
        el.scrollIntoView({ behavior: "smooth", block: "start" });
        // small offset for sticky-ish feel
        setTimeout(() => {
          const y = el.getBoundingClientRect().top + window.scrollY - 16;
          window.scrollTo({ top: y, behavior: "smooth" });
        }, 120);
      } catch {}
    }

    // ===========================
    // Results rendering (FIXED)
    // ===========================
    function setResultUI(payload) {
      const data = payload || {};

      // accept multiple backend naming styles
      const scam = pickNumber(data, ["scam_score", "scamScore", "scam", "risk", "risk_score"], 0);
      const ai = pickNumber(data, ["ai_probability", "aiProb", "ai_probability_pct", "ai_voice_probability", "aiVoiceProbability"], 0);
      const stress = pickNumber(data, ["stress_level", "stressLevel", "stress", "stress_score"], 0);

      const summary = pickText(data, ["summary", "explanation", "message"], "Analysis complete.");
      const flags = normalizeFlags(data.flags || data.signals || data.red_flags || data.redFlags);

      scamScoreEl.textContent = String(Math.round(clampPct(scam)));
      aiProbEl.textContent = String(Math.round(clampPct(ai)));
      stressLevelEl.textContent = String(Math.round(clampPct(stress)));

      summaryText.textContent = summary;

      flagsWrap.innerHTML = "";
      flags.forEach(f => {
        const chip = document.createElement("span");
        chip.className = "chip rounded-full px-3 py-1 text-xs";
        chip.textContent = f;
        flagsWrap.appendChild(chip);
      });

      setBars(scam, ai, stress);
      scrollToResults();
    }
    function runInvestorDemo() {

  localStorage.setItem("vs_demo", "true");

  const demoData = {
    
    scam_score: 82,
    ai_probability: 91,
    stress_level: 67,
    summary: "High likelihood of AI-generated impersonation with financial manipulation intent.",
    flags: [
      "AI voice synthesis detected",
      "Urgency pressure language",
      "Financial request pattern",
      "Emotional manipulation markers"
    ]
  };

  setResultUI(demoData);

  document.getElementById("resultsCard")
    ?.scrollIntoView({ behavior: "smooth", block: "start" });

  toast("Demo AI analysis complete ‚úì");
}

    // Demo result (for investor impression)
    function loadDemoResult() {
      setResultUI({
        scam_score: 78,
        ai_probability: 86,
        stress_level: 64,
        summary:
          "High-risk pattern detected. Voice characteristics suggest synthetic generation and urgency-driven coercion typical in financial fraud calls. Verify identity via official channels before taking action.",
        flags: [
          "Synthetic timbre signature",
          "Urgency / pressure language",
          "Financial request marker",
          "Impersonation phrasing",
          "Call-flow inconsistency"
        ]
      });
      lastResponse = { demo: true };
      if (rawJson) {
        rawJson.textContent = JSON.stringify({ demo: true }, null, 2);
        rawJson.classList.remove("hidden");
      }
      toast("Demo result loaded.");
    }

    // ===========================
    // Mode + health
    // ===========================
    function setStatus(text) { $("backendStatus").textContent = text; }

    async function checkBackend() {
      try {
        const r = await fetch(`${backendBase}/health`, { cache: "no-store" });
        if (!r.ok) throw new Error("health not ok");
        const j = await r.json().catch(() => ({}));
        setStatus(`OK ‚Ä¢ AI: ${j.ai_url || "unknown"}`);
      } catch {
        setStatus("Offline / blocked (check URL, CORS, or server)");
      }
    }

    function setMode(mode) {
      backendBase = URLS[mode];
      $("backendUrl").textContent = backendBase;
      $("modeLabel").textContent = mode;

      const activeCls = " ring-2 ring-yellow-300/30";
      btnProd.className = btnProd.className.replace(activeCls, "");
      btnLocal.className = btnLocal.className.replace(activeCls, "");
      if (mode === "PROD") btnProd.className += activeCls;
      else btnLocal.className += activeCls;

      checkBackend();
      toast(`Mode: ${mode}`);
    }

    btnProd.addEventListener("click", () => setMode("PROD"));
    btnLocal.addEventListener("click", () => setMode("LOCAL"));
    setMode("PROD");

    // ===========================
    // Waitlist (local prototype)
    // ===========================
    function joinEarlyAccess() {
      const count = Number(localStorage.getItem("waitlist") || 0);
      localStorage.setItem("waitlist", String(count + 1));
      renderWaitlistCount();
      toast("Joined early access ‚úì");
    }

    function renderWaitlistCount() {
      const count = Number(localStorage.getItem("waitlist") || 0);
      const top = $("waitlistCountTop");
      const badge = $("waitlistCountBadge");
      const text = $("waitlistCountText");
      if (top) top.textContent = String(count);
      if (badge) badge.textContent = String(count);
      if (text) text.textContent = `Total early access sign-ups: ${count}`;
    }

    const cities = ["Vienna", "Warsaw", "Amsterdam", "Paris", "Madrid", "New York", "Toronto"];
    (function simulateLiveJoins(){
      const el = $("liveActivity");
      if (!el) return;
      setInterval(() => {
        const city = cities[Math.floor(Math.random() * cities.length)];
        const seconds = Math.floor(Math.random() * 40) + 5;
        el.textContent = `üî• Someone from ${city} joined ${seconds}s ago`;
      }, 6500);
    })();

    renderWaitlistCount();

    joinWaitlistBtn.addEventListener("click", joinEarlyAccess);

    // ===========================
    // HOW modal
    // ===========================
    const howModal = $("howModal");
    const howBackdrop = $("howBackdrop");
    const howClose = $("howClose");
    const howTryDemo = $("howTryDemo");
    const howGoAnalyze = $("howGoAnalyze");

    function openHow() { howModal.classList.remove("hidden"); howModal.classList.add("flex"); }
    function closeHow(){ howModal.classList.add("hidden"); howModal.classList.remove("flex"); }

    ctaHow.addEventListener("click", openHow);
    if (howBackdrop) howBackdrop.addEventListener("click", closeHow);
    if (howClose) howClose.addEventListener("click", closeHow);
    if (howTryDemo) howTryDemo.addEventListener("click", () => { closeHow(); loadDemoResult(); });
    if (howGoAnalyze) howGoAnalyze.addEventListener("click", () => {
      closeHow();
      $("analyzer")?.scrollIntoView({ behavior:"smooth", block:"start" });
    });

    // Hero CTAs
    ctaAnalyze.addEventListener("click", () => $("analyzer")?.scrollIntoView({ behavior:"smooth", block:"start" }));
    ctaDemo.addEventListener("click", loadDemoResult);

    // ===========================
    // PAYWALL
    // ===========================
    function openPaywall(){
      const m = $("paywallModal");
      if (!m) return;
      m.classList.remove("hidden");
      m.classList.add("flex");
      renderWaitlistCount();
    }
    function closePaywall(){
      const m = $("paywallModal");
      if (!m) return;
      m.classList.add("hidden");
      m.classList.remove("flex");
    }

    $("paywallBackdrop")?.addEventListener("click", closePaywall);
    $("paywallClose")?.addEventListener("click", closePaywall);
    $("paywallWaitlist")?.addEventListener("click", () => { joinEarlyAccess(); closePaywall(); });

    // ===========================
    // Stripe buttons
    // ===========================
    upgradeBtn.addEventListener("click", () => window.location.href = STRIPE_CHECKOUT_URL);
    $("paywallCta")?.addEventListener("click", () => window.location.href = STRIPE_CHECKOUT_URL);

    manageSubBtn.addEventListener("click", () => {
      if (!STRIPE_BILLING_PORTAL_URL) {
        toast("Add your Stripe Billing Portal URL in code.");
        return;
      }
      window.open(STRIPE_BILLING_PORTAL_URL, "_blank", "noopener,noreferrer");
    });

    // ===========================
    // File selection
    // ===========================
    fileInput.addEventListener("change", () => {
      const f = fileInput.files && fileInput.files[0];
      if (f) {
        fileHint.textContent = `Selected: ${f.name} (${Math.round(f.size / 1024)} KB)`;
      } else {
        fileHint.textContent = "No file selected.";
      }
    });

    // ===========================
    // Record microphone
    // ===========================
    let mediaRecorder = null;
    let recordedChunks = [];
    let recording = false;

    recordBtn.addEventListener("click", async () => {
      try {
        if (!recording) {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          recordedChunks = [];
          mediaRecorder = new MediaRecorder(stream);

          mediaRecorder.ondataavailable = (e) => {
            if (e.data && e.data.size > 0) recordedChunks.push(e.data);
          };

          mediaRecorder.onstop = () => {
            try {
              const blob = new Blob(recordedChunks, { type: "audio/webm" });
              const file = new File([blob], "mic.webm", { type: "audio/webm" });
              const dt = new DataTransfer();
              dt.items.add(file);
              fileInput.files = dt.files;
              fileHint.textContent = `Recorded: ${file.name} (${Math.round(file.size / 1024)} KB)`;
              toast("Recording saved ‚úì");
            } catch {
              toast("Could not finalize recording.");
            }
          };

          mediaRecorder.start();
          recording = true;
          recordBtn.innerHTML = `<i class="fa-solid fa-stop mr-2"></i>Stop`;
          toast("Recording‚Ä¶");
        } else {
          mediaRecorder.stop();
          recording = false;
          recordBtn.innerHTML = `<i class="fa-solid fa-microphone mr-2"></i>Record`;
        }
      } catch {
        alert("Microphone permission blocked or unavailable.");
      }
    });

    // ===========================
    // Analyze
    // ===========================
function setResultUI(data) {

  if (!data) return;

  const scam = Number(
    data.scam_score ??
    data.scamScore ??
    0
  );

  const ai = Number(
    data.ai_probability ??
    data.aiProb ??
    0
  );

  const stress = Number(
    data.stress_level ??
    data.stressLevel ??
    0
  );

  // TEXT VALUES
  document.getElementById("scamScore").textContent = scam;
  document.getElementById("aiProb").textContent = ai;
  document.getElementById("stressLevel").textContent = stress;

  // BARS
  document.getElementById("scamBar").style.width = scam + "%";
  document.getElementById("aiBar").style.width = ai + "%";
  document.getElementById("stressBar").style.width = stress + "%";

  // SUMMARY
  document.getElementById("summaryText").textContent =
    data.summary || "Analysis completed.";

  // FLAGS
  const wrap = document.getElementById("flagsWrap");
  wrap.innerHTML = "";

  (data.flags || []).forEach(f => {
    const el = document.createElement("div");
    el.className =
      "chip px-3 py-1 rounded-full text-xs";
    el.textContent = f;
    wrap.appendChild(el);
  });

  // AUTO SCROLL TO RESULTS
document.getElementById("resultsCard")
  ?.scrollIntoView({ behavior: "smooth", block: "start" });


  // üî• AUTO SCROLL (INVESTOR UX)
  document
    .getElementById("resultsCard")
    ?.scrollIntoView({
      behavior: "smooth",
      block: "start"
    });
}

     if (analyzeBtn) {

  analyzeBtn.addEventListener("click", async () => {

    // =========================
    // FREE LIMIT
    // =========================
   const isPro = localStorage.getItem("voicesafe_pro") === "true";
const FREE_LIMIT = 3;
let usage = Number(localStorage.getItem("vs_usage") || 0);

// demo mode never counts
const DEMO_MODE = localStorage.getItem("vs_demo") === "true";

if (!isPro && !DEMO_MODE && usage >= FREE_LIMIT) {
  openPaywall();
  return;

    }

    // =========================
    // Progress text
    // =========================
    const steps = [
      "Uploading sample...",
      "Analyzing voice pattern...",
      "Detecting AI voice cloning...",
      "Measuring stress markers...",
      "Scanning scam signals...",
      "Finalizing risk report..."
    ];

    let stepIndex = 0;
    summaryText.textContent = steps[0];

    if (progressInterval) clearInterval(progressInterval);
    progressInterval = setInterval(() => {
      stepIndex = Math.min(stepIndex + 1, steps.length - 1);
      summaryText.textContent = steps[stepIndex];
    }, 850);

    // count usage
    localStorage.setItem("vs_usage", String(isPro ? usage : usage + 1));

    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = '<i class="fa-solid fa-spinner mr-2 fa-spin"></i>Analyzing...';
    flagsWrap.innerHTML = "";
    setBars(0,0,0);
    if (rawJson) rawJson.classList.add("hidden");

const startTime = Date.now();

    try {

      const form = new FormData();
      form.append("file", f);

      // optional metadata
      form.append("title", titleEl?.value || "");
      form.append("platform", platformEl?.value || "");
      form.append("country", countryEl?.value || "");
      form.append("language", languageEl?.value || "");
      form.append("tags", tagsEl?.value || "");
      form.append("notes", notesEl?.value || "");

      const resp = await fetch(`${backendBase}/upload`, {
        method: "POST",
        body: form
      });

      const data = await resp.json().catch(() => null);

      if (!resp.ok) {
        const msg = (data && (data.message || data.error)) || "Server error";
        summaryText.textContent = `Error: ${msg}`;
        toast("Analyze failed.");
        return;
      }

      const aiResult = (data && (data.aiResult || data.result || data)) || {};
      lastResponse = aiResult;

      setResultUI(aiResult);

      lastCaseId =
        data?.case_id ||
        data?.caseId ||
        data?.id ||
        aiResult?.case_id ||
        null;

      if (lastCaseId) {
        caseIdEl.textContent = String(lastCaseId);
        caseSavedHint.textContent = "Case saved.";
        shareBtn.disabled = false;
      } else {
        caseIdEl.textContent = "‚Äî";
        caseSavedHint.textContent = "No case id returned by backend.";
        shareBtn.disabled = true;
      }

      if (rawJson) {
        rawJson.textContent = JSON.stringify(data, null, 2);
        rawJson.classList.remove("hidden");
      }

      toast("Analysis complete ‚úì");

    } catch (e) {

      summaryText.textContent = "Network error (check backend URL / CORS).";
      toast("Network error.");

    } finally {

  const elapsed = Date.now() - startTime;
  const MIN_TIME = 800;

  if (elapsed < MIN_TIME) {
    await new Promise(r => setTimeout(r, MIN_TIME - elapsed));
  }

  if (progressInterval) {
    clearInterval(progressInterval);
    progressInterval = null;
  }

  analyzeBtn.disabled = false;
  analyzeBtn.innerHTML =
    '<i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Analyze';

}

  });

  if (demoBtn) {
  demoBtn.addEventListener("click", runInvestorDemo);
}

}
    

    // ===========================
    // Copy / Share
    // ===========================
    copyJsonBtn.addEventListener("click", async () => {
      try {
        if (!lastResponse) { toast("No result to copy."); return; }
        await navigator.clipboard.writeText(JSON.stringify(lastResponse, null, 2));
        toast("Copied JSON ‚úì");
      } catch {
        alert("Copy failed (clipboard permission).");
      }
    });

    shareBtn.addEventListener("click", async () => {
      if (!lastCaseId) { toast("No case id to share."); return; }
      const url = new URL(window.location.href);
      url.searchParams.set("case", String(lastCaseId));
      try {
        await navigator.clipboard.writeText(url.toString());
        toast("Share link copied ‚úì");
      } catch {
        alert("Could not copy. Share link: " + url.toString());
      }
    });

    // ===========================
    // Search / Load cases (optional)
    // ===========================
    function escapeHtml(s) {
      return (s || "").replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    }

    function renderSearchList(items) {
      resultsList.innerHTML = "";
      if (!items || !items.length) {
        resultsList.innerHTML = `<div class="text-xs muted">No results.</div>`;
        return;
      }
      items.slice(0, 25).forEach(item => {
        const id = item.id || item.case_id || item._id;
        const title = item?.meta?.title || item?.title || "(untitled)";
        const platform = item?.meta?.platform || item?.platform || "";
        const when = item?.created_at || item?.createdAt;
        const whenTxt = when ? new Date(when).toLocaleString() : "";

        const row = document.createElement("div");
        row.className = "chip rounded-xl p-3 mb-2 cursor-pointer hover:opacity-90";
        row.innerHTML = `
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="text-sm font-semibold truncate">${escapeHtml(title)}</div>
              <div class="text-xs muted truncate">${escapeHtml(platform)} ${whenTxt ? "‚Ä¢ " + escapeHtml(whenTxt) : ""}</div>
              <div class="text-[11px] muted mono break-all mt-1">${escapeHtml(id || "")}</div>
            </div>
            <div class="text-sm font-extrabold gold-text shrink-0">Load</div>
          </div>
        `;
        row.addEventListener("click", () => loadCase(id));
        resultsList.appendChild(row);
      });
    }

    async function doSearch() {
      const q = (searchQ.value || "").trim();
      const tag = (searchTag.value || "").trim();
      const url = new URL(`${backendBase}/cases`);
      if (q) url.searchParams.set("q", q);
      if (tag) url.searchParams.set("tag", tag);

      resultsList.innerHTML = `<div class="text-xs muted">Searching‚Ä¶</div>`;
      try {
        const r = await fetch(url.toString(), { cache: "no-store" });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(j?.message || "Search failed");
        renderSearchList(j?.cases || j?.items || []);
      } catch {
        resultsList.innerHTML = `<div class="text-xs muted">Search error. (Backend may not support /cases)</div>`;
      }
    }

    async function loadCase(id) {
      if (!id) return;
      summaryText.textContent = "Loading case‚Ä¶";
      scrollToResults();

      try {
        const r = await fetch(`${backendBase}/case/${encodeURIComponent(id)}`, { cache: "no-store" });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) {
          summaryText.textContent = `Could not load case: ${j?.message || "Error"}`;
          toast("Load failed.");
          return;
        }

        const c = j.case || j.item || j;
        const meta = c.meta || {};
        const data = c.data || c;

        titleEl.value = meta.title || c.title || "";
        platformEl.value = meta.platform || c.platform || "";
        countryEl.value = meta.country || c.country || "";
        languageEl.value = meta.language || c.language || "";
        tagsEl.value = Array.isArray(meta.tags) ? meta.tags.join(", ") : (meta.tags || "");
        notesEl.value = meta.notes || c.notes || "";

        lastResponse = data;
        setResultUI(data);

        lastCaseId = c.id || c._id || id;
        caseIdEl.textContent = String(lastCaseId);
        caseSavedHint.textContent = "Loaded from saved cases.";
        shareBtn.disabled = false;

        if (rawJson) {
          rawJson.textContent = JSON.stringify(j, null, 2);
          rawJson.classList.remove("hidden");
        }

        const url = new URL(window.location.href);
        url.searchParams.set("case", String(lastCaseId));
        history.replaceState({}, "", url.toString());

        toast("Case loaded ‚úì");
      } catch {
        summaryText.textContent = "Could not load case (network error).";
        toast("Network error.");
      }
    }

    searchBtn.addEventListener("click", doSearch);
    clearBtn.addEventListener("click", () => {
      searchQ.value = "";
      searchTag.value = "";
      resultsList.innerHTML = "";
      toast("Cleared.");
    });

    // Auto-load from share link ?case=...
    (function boot(){
      const u = new URL(window.location.href);
      const id = u.searchParams.get("case");
      if (id) loadCase(id);
    })();

    // ===========================
    // Stripe SUCCESS detection (simple)
    // ===========================
    if (window.location.pathname.includes("success")) {
      localStorage.setItem("voicesafe_pro", "true");
      alert("‚úÖ PRO activated successfully!");
      window.location.href = "/";
    }

  </script>

<div style="text-align:center;opacity:.5;font-size:12px;margin-top:60px;margin-bottom:20px">
  VoiceSafe.ai ‚Ä¢ AI Fraud Prevention Tool ‚Ä¢ BUILD: 2026-02-27-001
</div>

</body>
</html>