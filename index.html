<!-- file: frontend/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

  <title>VoiceSafe.ai ‚Äî Detect AI Voice Scams Before You Send Money</title>
  <meta name="description" content="VoiceSafe detects impersonation, AI voice cloning and scam risk in seconds. Upload a voice message and get an AI risk assessment report before sending money." />

  <!-- Canonical -->
  <link rel="canonical" href="https://voicesafe.ai" />

  <!-- OpenGraph -->
  <meta property="og:title" content="VoiceSafe.ai ‚Äî AI Voice Scam Detection" />
  <meta property="og:description" content="Upload a voice message and detect impersonation, AI cloning and scam risk instantly." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://voicesafe.ai" />
  <meta property="og:image" content="https://voicesafe.ai/og-image.png" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="VoiceSafe.ai ‚Äî AI Voice Scam Detection" />
  <meta name="twitter:description" content="Analyze voice recordings and detect impersonation or AI scam risk instantly." />
  <meta name="twitter:image" content="https://voicesafe.ai/og-image.png" />

  <!-- Favicons / PWA -->
  <link rel="icon" href="/favicon.png" type="image/png" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <link rel="manifest" href="/manifest.webmanifest" />

  <!-- Tailwind (prototype ok) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1220;
      --stroke:rgba(255,255,255,.10);
      --gold1:#F7D774;
      --gold2:#C9A24A;
      --muted:rgba(255,255,255,.72);
      --ok:#22c55e;
      --bad:#ef4444;
    }

    html,body{height:100%;}
    body{
      background:
        radial-gradient(1000px 600px at 20% 10%, rgba(247,215,116,.10), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(201,162,74,.10), transparent 60%),
        radial-gradient(900px 700px at 50% 100%, rgba(99,102,241,.10), transparent 60%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
      color:#fff;
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }
    *{box-sizing:border-box;}
    img,video,canvas,svg{max-width:100%;height:auto;}
    pre{white-space:pre-wrap;word-break:break-word;}

    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
    }
    .gold-border{
      border:1px solid rgba(247,215,116,.35);
      box-shadow:0 0 0 1px rgba(201,162,74,.20) inset;
    }
    .gold-text{
      background:linear-gradient(90deg,var(--gold1),var(--gold2));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .muted{color:var(--muted);}

    .chip{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
    }
    .btn-gold{
      background:linear-gradient(90deg, rgba(247,215,116,1), rgba(201,162,74,1));
      color:#111827;
      box-shadow:0 10px 30px rgba(247,215,116,.15);
      transition:transform .12s ease, filter .12s ease;
    }
    .btn-gold:hover{filter:brightness(1.03); transform:translateY(-1px);}
    .btn-gold:active{transform:translateY(0);}
    .btn-gold:disabled{opacity:.45;cursor:not-allowed;box-shadow:none;transform:none;}

    .primary-btn{
      border-radius:0.9rem;
      padding:.65rem 1rem;
      font-size:.9rem;
      font-weight:900;
      background:linear-gradient(90deg, rgba(247,215,116,1), rgba(201,162,74,1));
      color:#111827;
      box-shadow:0 10px 30px rgba(247,215,116,.15);
      transition:transform .12s ease, filter .12s ease;
      white-space:nowrap;
    }
    .primary-btn:hover{filter:brightness(1.03); transform:translateY(-1px);}
    .primary-btn:active{transform:translateY(0);}

    .bar{
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .bar>div{
      height:100%;
      border-radius:999px;
      background:linear-gradient(90deg, rgba(247,215,116,1), rgba(201,162,74,1));
      width:0%;
      transition:width .35s ease;
    }
    .mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    .safe-pb{padding-bottom:env(safe-area-inset-bottom);}

    .live-dot{
      width:8px;height:8px;border-radius:999px;
      background:var(--ok);
      box-shadow:0 0 0 0 rgba(34,197,94,.7);
      animation:livePulse 1.4s infinite;
    }
    @keyframes livePulse{
      0%{ box-shadow:0 0 0 0 rgba(34,197,94,.7); }
      70%{ box-shadow:0 0 0 12px rgba(34,197,94,0); }
      100%{ box-shadow:0 0 0 0 rgba(34,197,94,0); }
    }

    .soft-line{border-top:1px solid rgba(255,255,255,.10);}
  </style>
</head>

<body class="min-h-screen safe-pb">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-8 sm:py-10">

    <!-- TOP BADGE -->
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="inline-flex items-center gap-2 chip px-3 py-1 rounded-full text-xs">
        <i class="fa-solid fa-shield-halved"></i>
        <span class="muted">Public Beta ‚Ä¢ Privacy-first ‚Ä¢ Global</span>
      </div>

      <div class="inline-flex items-center gap-2 text-xs muted">
        <span class="live-dot"></span>
        <span id="liveActivity">Live activity loading‚Ä¶</span>
      </div>
    </div>

    <!-- HERO -->
    <div class="mt-6 flex flex-col lg:flex-row lg:items-end lg:justify-between gap-6">
      <div class="min-w-0 max-w-3xl">
        <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold leading-tight">
          <span class="gold-text">VoiceSafe.ai</span>
          <span class="text-white">Detect AI Voice Scams</span>
          <span class="text-white/85">before you send money.</span>
        </h1>

        <p class="mt-3 muted text-sm sm:text-base">
          Upload a voice message (WhatsApp/Telegram/Viber audio) and get an <span class="text-white/90 font-semibold">AI Risk Assessment Report</span>
          in seconds ‚Äî impersonation, cloning, pressure tactics, and scam patterns.
        </p>

        <div class="mt-4 flex flex-wrap gap-2 text-xs">
          <span class="chip px-3 py-1 rounded-full">AI Voice Detection</span>
          <span class="chip px-3 py-1 rounded-full">Impersonation Protection</span>
          <span class="chip px-3 py-1 rounded-full">Financial Scam Prevention</span>
          <span class="chip px-3 py-1 rounded-full">Built for global scale</span>
        </div>

        <div class="mt-4 text-xs opacity-80">
          üî• <span id="waitlistCountBadge">0</span> early access sign-ups ‚Ä¢
          <span id="waitlistUrgency">Early access is open now.</span>
        </div>
      </div>

      <!-- STATUS CARD -->
      <div class="glass gold-border rounded-2xl p-4 w-full lg:w-[420px]">
        <div class="flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="text-sm font-semibold">Backend status</div>
            <div class="text-xs muted truncate" id="backendStatus">Checking‚Ä¶</div>
          </div>
          <div class="text-right shrink-0">
            <div class="text-xs muted">Mode</div>
            <div class="text-sm font-semibold gold-text" id="modeLabel">PROD</div>
          </div>
        </div>

        <div class="mt-3 text-xs muted break-all">
          <span class="mono" id="backendUrl"></span>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="btnProd" class="chip rounded-xl px-3 py-2 text-xs font-semibold w-1/2 hover:opacity-90">PROD</button>
          <button id="btnLocal" class="chip rounded-xl px-3 py-2 text-xs font-semibold w-1/2 hover:opacity-90">LOCAL</button>
        </div>

        <div class="mt-2 text-[11px] muted">
          Tip: Use LOCAL only when backend runs on <span class="mono">http://127.0.0.1:10000</span>
        </div>
      </div>
    </div>

    <!-- MAIN GRID -->
    <div class="mt-6 sm:mt-8 grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 items-start">

      <!-- LEFT: UPLOAD / RECORD -->
      <div class="lg:col-span-1 glass rounded-2xl p-5 sm:p-6">
        <h2 class="text-lg font-semibold">Analyze a recording</h2>
        <p class="muted text-sm mt-1">Upload an audio/video file or record a short clip.</p>

        <div class="mt-5">
          <label class="block text-sm muted mb-2" for="fileInput">Upload audio or chat audio/video</label>
          <input id="fileInput" type="file" accept="audio/*,video/*" class="w-full text-sm chip rounded-xl p-3 outline-none" />
          <div class="mt-2 text-xs muted" id="fileHint">No file selected.</div>
        </div>

        <div class="mt-5 grid grid-cols-2 gap-3">
          <button id="recordBtn" type="button" class="chip rounded-xl px-4 py-3 text-sm font-semibold hover:opacity-90">
            <i class="fa-solid fa-microphone mr-2"></i>Record
          </button>

          <button id="analyzeBtn" type="button" class="btn-gold rounded-xl px-4 py-3 text-sm font-extrabold" disabled>
            <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Analyze
          </button>
        </div>

        <div class="mt-3 text-xs muted">
          Free 3 analyses ‚Ä¢ No signup required ‚Ä¢ Privacy-first
        </div>

        <div class="mt-4 chip rounded-xl p-3 text-xs muted">
          <div class="font-semibold text-white/90">Trust & privacy</div>
          <div class="mt-1 leading-relaxed">
            üîí Privacy-first ‚Ä¢ avoid personal data in notes<br/>
            ‚ö° Instant AI risk assessment<br/>
            üõ° Detect pressure + impersonation patterns<br/>
            üåç Built for global safety
          </div>
        </div>

        <!-- OPTIONAL CASE META -->
        <div class="mt-5 soft-line pt-5">
          <h3 class="text-sm font-semibold">Case details (optional)</h3>
          <p class="muted text-xs mt-1">Saved cases can be searched & shared (if backend supports it).</p>

          <div class="mt-4 space-y-3">
            <input id="title" class="w-full chip rounded-xl p-3 text-sm outline-none" placeholder="Title (e.g. 'Telegram investor')" />
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <input id="platform" class="w-full chip rounded-xl p-3 text-sm outline-none" placeholder="Platform (Telegram)" />
              <input id="country" class="w-full chip rounded-xl p-3 text-sm outline-none" placeholder="Country (US)" />
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <input id="language" class="w-full chip rounded-xl p-3 text-sm outline-none" placeholder="Language (EN)" />
              <input id="tags" class="w-full chip rounded-xl p-3 text-sm outline-none" placeholder="Tags (comma separated)" />
            </div>
            <textarea id="notes" rows="3" class="w-full chip rounded-xl p-3 text-sm outline-none" placeholder="Notes (what happened)"></textarea>
          </div>

          <div class="mt-4 text-xs muted">
            Tip: Keep personal data out of notes. This is a prototype.
          </div>
        </div>

        <div class="mt-5 chip rounded-xl p-3 text-xs muted">
          <div class="font-semibold text-white/90">Disclaimer</div>
          <div class="mt-1">
            Scores are prototypes and can be wrong. Always verify identity using official channels.
          </div>
        </div>
      </div>

      <!-- RIGHT: RESULTS -->
      <div id="resultsCard" class="lg:col-span-2 glass rounded-2xl p-5 sm:p-6">
        <div style="font-size:12px;opacity:.65;margin-bottom:8px;letter-spacing:.08em;text-transform:uppercase;">
          AI Risk Assessment Report
        </div>

        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="min-w-0">
            <h2 class="text-lg font-semibold">Results</h2>
            <p class="muted text-sm mt-1">Risk signals, explanation and summary.</p>
          </div>

          <div class="flex items-center gap-2 flex-wrap">
            <button id="copyJsonBtn" class="chip rounded-xl px-4 py-2 text-sm font-semibold hover:opacity-90">
              <i class="fa-regular fa-copy mr-2"></i>Copy JSON
            </button>

            <button id="shareBtn" class="chip rounded-xl px-4 py-2 text-sm font-semibold hover:opacity-90" disabled>
              <i class="fa-solid fa-link mr-2"></i>Share
            </button>

            <button id="upgradeBtn" class="primary-btn">
              üöÄ Unlock Unlimited Voice Checks & AI Reports ‚Äì ‚Ç¨9/month
            </button>

            <button id="manageSubBtn" class="chip rounded-xl px-4 py-2 text-sm hover:opacity-90">
              Manage subscription
            </button>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Scam score</div>
            <div class="mt-1 text-3xl font-extrabold">
              <span id="scamScore">‚Äî</span><span class="text-base muted">%</span>
            </div>
            <div class="mt-3 bar"><div id="scamBar"></div></div>
          </div>

          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">AI voice probability</div>
            <div class="mt-1 text-3xl font-extrabold">
              <span id="aiProb">‚Äî</span><span class="text-base muted">%</span>
            </div>
            <div class="mt-3 bar"><div id="aiBar"></div></div>
          </div>

          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Stress level</div>
            <div class="mt-1 text-3xl font-extrabold">
              <span id="stressLevel">‚Äî</span><span class="text-base muted">%</span>
            </div>
            <div class="mt-3 bar"><div id="stressBar"></div></div>
          </div>
        </div>

        <div class="mt-5 chip rounded-2xl p-5">
          <div class="text-xs muted">Summary</div>
          <div class="mt-2 text-slate-100 text-sm sm:text-base" id="summaryText">
            Upload a sample to see results.
          </div>
          <div class="mt-3 flex flex-wrap gap-2" id="flagsWrap"></div>
        </div>

        <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="chip rounded-2xl p-5">
            <div class="text-sm font-semibold">Saved case</div>
            <div class="mt-2 text-xs muted">Case ID</div>
            <div class="mt-1 mono text-sm break-all" id="caseId">‚Äî</div>
            <div class="mt-3 text-xs muted" id="caseSavedHint">Analyze a sample to create a case.</div>
          </div>

          <div class="chip rounded-2xl p-5">
            <div class="text-sm font-semibold">Search cases</div>

            <div class="mt-3 flex gap-2">
              <input id="searchQ" class="flex-1 chip rounded-xl p-3 text-sm outline-none min-w-0" placeholder="Search title / notes..." />
              <button id="searchBtn" class="btn-gold rounded-xl px-4 py-3 text-sm font-extrabold shrink-0">Search</button>
            </div>

            <div class="mt-3 flex gap-2">
              <input id="searchTag" class="flex-1 chip rounded-xl p-3 text-sm outline-none min-w-0" placeholder="Tag filter (optional)" />
              <button id="clearBtn" class="chip rounded-xl px-4 py-3 text-sm font-semibold hover:opacity-90 shrink-0">Clear</button>
            </div>

            <div class="mt-4 pr-1 overflow-auto" id="resultsList" style="max-height:min(46vh,360px);"></div>
          </div>
        </div>

        <pre class="mt-5 chip rounded-2xl p-4 text-xs overflow-auto hidden" id="rawJson" style="max-height:min(40vh,320px);"></pre>
      </div>
    </div>

    <div class="mt-10 text-center text-xs muted">
      VoiceSafe.ai ‚Ä¢ AI Fraud Prevention Tool ‚Ä¢ Built 2026
    </div>
  </div>

  <!-- PAYWALL MODAL -->
  <div id="paywallModal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div id="paywallBackdrop" class="absolute inset-0 bg-black/60"></div>

    <div class="relative w-[92%] max-w-lg rounded-2xl border border-white/10 bg-[#0b0f14] p-6 shadow-xl">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-xl font-semibold">Free limit reached</h3>
          <p class="mt-1 text-sm opacity-80">Upgrade to VoiceSafe Pro to continue analyzing.</p>
        </div>
        <button id="paywallClose" class="rounded-lg px-3 py-1 text-sm chip">‚úï</button>
      </div>

      <div class="mt-4 grid gap-2 text-sm opacity-90">
        <div>‚úì Unlimited analyses</div>
        <div>‚úì Priority AI detection</div>
        <div>‚úì Full AI Risk Report</div>
        <div>‚úì Case history & sharing</div>
      </div>

      <div class="mt-6 flex flex-col gap-2">
        <button id="paywallCta" class="btn-gold rounded-xl px-4 py-3 text-sm font-extrabold w-full">
          Start Pro ‚Äì ‚Ç¨9/month
        </button>

        <button id="paywallWaitlist" class="chip rounded-xl px-4 py-3 text-sm font-semibold hover:opacity-90 w-full">
          Join early access
          <div id="waitlistUrgencyModal" class="mt-2 text-xs opacity-70 text-center"></div>
        </button>

        <p class="mt-2 text-xs opacity-60">
          (If payments are not available for your region yet, join early access and we‚Äôll prioritize your rollout.)
        </p>

        <p id="waitlistCountText" class="mt-2 text-xs opacity-70 text-center"></p>
      </div>
    </div>
  </div>

  <script>
    // ===========================
    // CONFIG
    // ===========================
    const URLS = {
      PROD: "https://voicesafe-backend-1.onrender.com",
      LOCAL: "http://127.0.0.1:10000",
    };
    let backendBase = URLS.PROD;

    // Stripe links (your current)
    const STRIPE_CHECKOUT_URL = "https://buy.stripe.com/aFa3cn42A8Iq1cC8m2gA800";
    const STRIPE_PORTAL_URL = "https://billing.stripe.com/p/login/aFa3cn42A8Iq1cC8m2gA800";

    // ===========================
    // DOM helpers
    // ===========================
    const $ = (id) => document.getElementById(id);

    const fileInput = $("fileInput");
    const analyzeBtn = $("analyzeBtn");
    const recordBtn = $("recordBtn");
    const fileHint = $("fileHint");

    const scamScoreEl = $("scamScore");
    const aiProbEl = $("aiProb");
    const stressLevelEl = $("stressLevel");

    const summaryText = $("summaryText");
    const flagsWrap = $("flagsWrap");
    const rawJson = $("rawJson");

    const scamBar = $("scamBar");
    const aiBar = $("aiBar");
    const stressBar = $("stressBar");

    const copyJsonBtn = $("copyJsonBtn");
    const shareBtn = $("shareBtn");
    const caseIdEl = $("caseId");
    const caseSavedHint = $("caseSavedHint");

    const searchQ = $("searchQ");
    const searchTag = $("searchTag");
    const searchBtn = $("searchBtn");
    const clearBtn = $("clearBtn");
    const resultsList = $("resultsList");

    const titleEl = $("title");
    const platformEl = $("platform");
    const countryEl = $("country");
    const languageEl = $("language");
    const tagsEl = $("tags");
    const notesEl = $("notes");

    const btnProd = $("btnProd");
    const btnLocal = $("btnLocal");
    const upgradeBtn = $("upgradeBtn");
    const manageSubBtn = $("manageSubBtn");

    const resultsCard = $("resultsCard");

    let lastResponse = null;
    let lastCaseId = null;
    let progressInterval = null;

    // ===========================
    // Utilities
    // ===========================
    function clampPct(v){
      const n = Number(v);
      if (!Number.isFinite(n)) return 0;
      return Math.max(0, Math.min(100, n));
    }
    function setBars(scam, ai, stress){
      scamBar.style.width = clampPct(scam) + "%";
      aiBar.style.width = clampPct(ai) + "%";
      stressBar.style.width = clampPct(stress) + "%";
    }
    function renderFlags(flags){
      flagsWrap.innerHTML = "";
      (Array.isArray(flags) ? flags : []).forEach(f => {
        const chip = document.createElement("span");
        chip.className = "chip px-3 py-1 rounded-full text-xs";
        chip.textContent = String(f);
        flagsWrap.appendChild(chip);
      });
    }

    function scrollToResults(){
      if (!resultsCard) return;
      resultsCard.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // Robust mapping (fix 0%)
    function pickAIProbability(data){
      return (
        data?.ai_voice_probability ??
        data?.ai_voice_prob ??
        data?.ai_probability ??
        data?.aiProb ??
        data?.ai ??
        0
      );
    }
    function pickScamScore(data){
      return (data?.scam_score ?? data?.scamScore ?? data?.scan_score ?? 0);
    }
    function pickStress(data){
      return (data?.stress_level ?? data?.stress ?? 0);
    }

    function setResultUI(data){
      const scam = pickScamScore(data);
      const ai = pickAIProbability(data);
      const stress = pickStress(data);

      scamScoreEl.textContent = String(clampPct(scam));
      aiProbEl.textContent = String(clampPct(ai));
      stressLevelEl.textContent = String(clampPct(stress));

      setBars(scam, ai, stress);

      summaryText.textContent =
        data?.summary ||
        data?.message ||
        "Analysis completed.";

      renderFlags(data?.flags || data?.signals || []);
    }

    // ===========================
    // Paywall
    // ===========================
    function openPaywall(){
      const m = $("paywallModal");
      if (!m) return;
      m.classList.remove("hidden");
      m.classList.add("flex");
      renderWaitlistCount();
    }
    function closePaywall(){
      const m = $("paywallModal");
      if (!m) return;
      m.classList.add("hidden");
      m.classList.remove("flex");
    }

    $("paywallBackdrop")?.addEventListener("click", closePaywall);
    $("paywallClose")?.addEventListener("click", closePaywall);

    // ===========================
    // Backend status + mode
    // ===========================
    function setStatus(text){ $("backendStatus").textContent = text; }

    async function checkBackend(){
      try{
        const r = await fetch(`${backendBase}/health`, { cache: "no-store" });
        if (!r.ok) throw new Error("health not ok");
        const j = await r.json().catch(() => ({}));
        setStatus(`‚úÖ ONLINE ‚Ä¢ AI: ${j.ai_url || "unknown"}`);
      }catch{
        setStatus("‚ùå Offline / blocked (check URL, CORS, or server)");
      }
    }

    function setMode(mode){
      backendBase = URLS[mode];
      $("backendUrl").textContent = backendBase;
      $("modeLabel").textContent = mode;

      const active = " border border-yellow-300/40";
      btnProd.className = btnProd.className.replace(active, "");
      btnLocal.className = btnLocal.className.replace(active, "");
      if (mode === "PROD") btnProd.className += active;
      else btnLocal.className += active;

      checkBackend();
    }

    btnProd.addEventListener("click", () => setMode("PROD"));
    btnLocal.addEventListener("click", () => setMode("LOCAL"));
    setMode("PROD");

    // ===========================
    // Stripe
    // ===========================
    upgradeBtn?.addEventListener("click", () => {
      window.location.href = STRIPE_CHECKOUT_URL;
    });

    manageSubBtn?.addEventListener("click", () => {
      window.open(STRIPE_PORTAL_URL, "_blank");
    });

    // If you later implement real success page, this keeps "pro" flag.
    if (window.location.pathname.includes("success")) {
      localStorage.setItem("voicesafe_pro", "true");
      alert("‚úÖ PRO activated successfully!");
      window.location.href = "/";
    }

    // ===========================
    // Waitlist / FOMO
    // ===========================
    function joinEarlyAccess(){
      const count = Number(localStorage.getItem("waitlist") || 0) + 1;
      localStorage.setItem("waitlist", String(count));

      const btn = $("paywallWaitlist");
      if (btn){
        btn.classList.add("opacity-70");
        btn.innerHTML = "Joined ‚úÖ";
        btn.disabled = true;
      }

      renderWaitlistCount();
      alert("You're on the early access list üöÄ");
    }
    $("paywallWaitlist")?.addEventListener("click", joinEarlyAccess);

    function renderWaitlistCount(){
      const count = Number(localStorage.getItem("waitlist") || 0);

      $("waitlistCountBadge") && ($("waitlistCountBadge").textContent = String(count));
      $("waitlistCountText") && ($("waitlistCountText").textContent = `Total early access sign-ups: ${count}`);

      const urgency = $("waitlistUrgency")?.textContent || "Early access is open now.";
      $("waitlistUrgencyModal") && ($("waitlistUrgencyModal").textContent = urgency);
    }

    const cities = ["Vienna","Warsaw","Amsterdam","Paris","Madrid","London","New York","Toronto","Singapore","Dubai"];
    function simulateLiveActivity(){
      const el = $("liveActivity");
      if (!el) return;

      setInterval(() => {
        const city = cities[Math.floor(Math.random()*cities.length)];
        const sec = Math.floor(Math.random()*45) + 8;
        el.textContent = `üî• ${city} ‚Ä¢ new scan started ${sec}s ago`;
      }, 5500);

      el.textContent = "üî• Global scans running now‚Ä¶";
    }

    simulateLiveActivity();
    renderWaitlistCount();

    // ===========================
    // File selection -> enable analyze
    // ===========================
    fileInput.addEventListener("change", () => {
      const f = fileInput.files && fileInput.files[0];
      if (f){
        fileHint.textContent = `Selected: ${f.name} (${Math.round(f.size/1024)} KB)`;
        analyzeBtn.disabled = false;
      }else{
        fileHint.textContent = "No file selected.";
        analyzeBtn.disabled = true;
      }
    });

    // ===========================
    // Record microphone
    // ===========================
    let mediaRecorder = null;
    let recordedChunks = [];
    let recording = false;

    recordBtn.addEventListener("click", async () => {
      try{
        if (!recording){
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          recordedChunks = [];
          mediaRecorder = new MediaRecorder(stream);

          mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) recordedChunks.push(e.data);
          };

          mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: "audio/webm" });
            const file = new File([blob], "mic.webm", { type: "audio/webm" });
            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;

            fileHint.textContent = `Recorded: ${file.name} (${Math.round(file.size/1024)} KB)`;
            analyzeBtn.disabled = false;
          };

          mediaRecorder.start();
          recording = true;
          recordBtn.innerHTML = `<i class="fa-solid fa-stop mr-2"></i>Stop`;
        }else{
          mediaRecorder.stop();
          recording = false;
          recordBtn.innerHTML = `<i class="fa-solid fa-microphone mr-2"></i>Record`;
        }
      }catch{
        alert("Microphone permission blocked or unavailable.");
      }
    });

    // ===========================
    // Analyze
    // ===========================
    function startInvestorProgress(){
      const steps = [
        "Analyzing voice biometrics‚Ä¶",
        "Detecting AI voice cloning artifacts‚Ä¶",
        "Measuring urgency / stress markers‚Ä¶",
        "Scanning scam patterns & intent‚Ä¶",
        "Generating AI Risk Report‚Ä¶"
      ];
      let i = 0;
      summaryText.textContent = steps[0];

      if (progressInterval) clearInterval(progressInterval);
      progressInterval = setInterval(() => {
        i++;
        if (i < steps.length) summaryText.textContent = steps[i];
      }, 850);
    }

    analyzeBtn.addEventListener("click", async () => {
      const f = fileInput.files && fileInput.files[0];

      if (!f){
        alert("Please select a file first.");
        return;
      }

      // FREE LIMIT
      const isPro = localStorage.getItem("voicesafe_pro") === "true";
      const FREE_LIMIT = 3;
      const usage = Number(localStorage.getItem("vs_usage") || 0);

      if (!isPro && usage >= FREE_LIMIT){
        openPaywall();
        return;
      }

      // increment usage
      localStorage.setItem("vs_usage", String(isPro ? usage : usage + 1));

      // UI state
      analyzeBtn.disabled = true;
      analyzeBtn.innerHTML = `<i class="fa-solid fa-spinner mr-2 fa-spin"></i>Analyzing‚Ä¶`;
      if (rawJson) rawJson.classList.add("hidden");
      renderFlags([]);

      startInvestorProgress();

      try{
        const form = new FormData();
        form.append("file", f);

        // optional meta
        form.append("title", titleEl.value || "");
        form.append("platform", platformEl.value || "");
        form.append("country", countryEl.value || "");
        form.append("language", languageEl.value || "");
        form.append("tags", tagsEl.value || "");
        form.append("notes", notesEl.value || "");

        const resp = await fetch(`${backendBase}/upload`, { method:"POST", body: form });
        const data = await resp.json().catch(() => null);

        if (!resp.ok){
          const msg = data?.message || `HTTP ${resp.status}`;
          summaryText.textContent = `Error: ${msg}`;
          setBars(0,0,0);
          return;
        }

        const payload = data?.aiResult || data?.case?.data || data;

        lastResponse = data;
        setResultUI(payload);
        scrollToResults();

        lastCaseId = data?.case_id || data?.case?.id || data?.id || null;
        if (lastCaseId){
          caseIdEl.textContent = String(lastCaseId);
          caseSavedHint.textContent = "Case saved. You can share it.";
          shareBtn.disabled = false;
        }else{
          caseIdEl.textContent = "‚Äî";
          caseSavedHint.textContent = "No case id returned (backend may not save cases).";
          shareBtn.disabled = true;
        }

        if (rawJson){
          rawJson.textContent = JSON.stringify(data, null, 2);
          rawJson.classList.remove("hidden");
        }

      }catch(e){
        summaryText.textContent = "Network error. Please retry.";
        setBars(0,0,0);
      }finally{
        if (progressInterval){
          clearInterval(progressInterval);
          progressInterval = null;
        }
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Analyze`;
      }
    });

    // ===========================
    // Copy / Share
    // ===========================
    copyJsonBtn.addEventListener("click", async () => {
      try{
        if (!lastResponse) return;
        await navigator.clipboard.writeText(JSON.stringify(lastResponse, null, 2));
        copyJsonBtn.textContent = "Copied ‚úì";
        setTimeout(() => {
          copyJsonBtn.innerHTML = `<i class="fa-regular fa-copy mr-2"></i>Copy JSON`;
        }, 900);
      }catch{
        alert("Copy failed (clipboard permission).");
      }
    });

    shareBtn.addEventListener("click", async () => {
      if (!lastCaseId) return;
      const url = new URL(window.location.href);
      url.searchParams.set("case", String(lastCaseId));
      try{
        await navigator.clipboard.writeText(url.toString());
        shareBtn.textContent = "Link copied ‚úì";
        setTimeout(() => {
          shareBtn.innerHTML = `<i class="fa-solid fa-link mr-2"></i>Share`;
        }, 1000);
      }catch{
        alert("Could not copy. Share link: " + url.toString());
      }
    });

    // ===========================
    // Search / Load cases (optional)
    // ===========================
    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function renderSearchList(items){
      resultsList.innerHTML = "";
      if (!items || !items.length){
        resultsList.innerHTML = `<div class="text-xs muted">No results.</div>`;
        return;
      }
      items.slice(0,25).forEach(item => {
        const id = item.id || item.case_id || item._id;
        const title = item?.meta?.title || item?.title || "(untitled)";
        const platform = item?.meta?.platform || item?.platform || "";
        const when = item?.created_at || item?.createdAt;
        const whenTxt = when ? new Date(when).toLocaleString() : "";

        const row = document.createElement("div");
        row.className = "chip rounded-xl p-3 mb-2 cursor-pointer hover:opacity-90";
        row.innerHTML = `
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="text-sm font-semibold truncate">${escapeHtml(title)}</div>
              <div class="text-xs muted truncate">${escapeHtml(platform)} ${whenTxt ? "‚Ä¢ " + escapeHtml(whenTxt) : ""}</div>
              <div class="text-[11px] muted mono break-all mt-1">${escapeHtml(id || "")}</div>
            </div>
            <div class="text-sm font-extrabold gold-text shrink-0">Load</div>
          </div>
        `;
        row.addEventListener("click", () => loadCase(id));
        resultsList.appendChild(row);
      });
    }

    async function doSearch(){
      const q = (searchQ.value || "").trim();
      const tag = (searchTag.value || "").trim();
      const url = new URL(`${backendBase}/cases`);
      if (q) url.searchParams.set("q", q);
      if (tag) url.searchParams.set("tag", tag);

      resultsList.innerHTML = `<div class="text-xs muted">Searching‚Ä¶</div>`;
      try{
        const r = await fetch(url.toString(), { cache:"no-store" });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(j?.message || "Search failed");
        renderSearchList(j?.cases || j?.items || []);
      }catch{
        resultsList.innerHTML = `<div class="text-xs muted">Search error. (Backend may not support /cases)</div>`;
      }
    }

    async function loadCase(id){
      if (!id) return;
      summaryText.textContent = "Loading case‚Ä¶";
      try{
        const r = await fetch(`${backendBase}/case/${encodeURIComponent(id)}`, { cache:"no-store" });
        const j = await r.json().catch(() => ({}));
        if (!r.ok){
          summaryText.textContent = `Could not load case: ${j?.message || "Error"}`;
          return;
        }
        const c = j.case || j.item || j;
        const meta = c.meta || {};
        const data = c.data || c;

        titleEl.value = meta.title || c.title || "";
        platformEl.value = meta.platform || c.platform || "";
        countryEl.value = meta.country || c.country || "";
        languageEl.value = meta.language || c.language || "";
        tagsEl.value = Array.isArray(meta.tags) ? meta.tags.join(", ") : (meta.tags || "");
        notesEl.value = meta.notes || c.notes || "";

        lastResponse = data;
        setResultUI(data);
        scrollToResults();

        lastCaseId = c.id || c._id || id;
        caseIdEl.textContent = String(lastCaseId);
        caseSavedHint.textContent = "Loaded from saved cases.";
        shareBtn.disabled = false;

        if (rawJson){
          rawJson.textContent = JSON.stringify(j, null, 2);
          rawJson.classList.remove("hidden");
        }

        const url = new URL(window.location.href);
        url.searchParams.set("case", String(lastCaseId));
        history.replaceState({}, "", url.toString());
      }catch{
        summaryText.textContent = "Could not load case (network error).";
      }
    }

    searchBtn.addEventListener("click", doSearch);
    clearBtn.addEventListener("click", () => {
      searchQ.value = "";
      searchTag.value = "";
      resultsList.innerHTML = "";
    });

    (function boot(){
      const u = new URL(window.location.href);
      const id = u.searchParams.get("case");
      if (id) loadCase(id);
    })();
  </script>
</body>
</html>