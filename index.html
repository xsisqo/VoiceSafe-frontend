<!-- file: frontend/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>VoiceSafe ‚Äî AI Voice Scam Detection</title>
  <meta name="description" content="Enterprise-grade AI voice scam detection. Upload or record audio and get a clear risk report in seconds." />

  <!-- OG / Twitter -->
  <meta property="og:title" content="VoiceSafe ‚Äî AI Voice Scam Detection" />
  <meta property="og:description" content="Upload or record a voice message and detect impersonation, AI cloning and scam risk instantly." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://voicesafe.ai/" />
  <meta property="og:image" content="/og-image.png" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- PWA -->
  <link rel="icon" href="/favicon.png" type="image/png" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#070A12" />

  <!-- Tailwind + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Structured data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "VoiceSafe",
    "applicationCategory": "SecurityApplication",
    "operatingSystem": "Web",
    "description": "AI voice scam detection and impersonation risk analysis.",
    "offers": { "@type": "Offer", "price": "9", "priceCurrency": "EUR" }
  }
  </script>

  <style>
    :root{
      --bg0:#070A12; --bg1:#0B1220;
      --stroke:rgba(255,255,255,.10);
      --gold1:#F7D774; --gold2:#C9A24A;
      --muted:rgba(255,255,255,.74);
      --shadow:0 22px 70px rgba(0,0,0,.55);
      --shadow2:0 14px 50px rgba(0,0,0,.45);
      --glassA:rgba(255,255,255,.07);
      --glassB:rgba(255,255,255,.03);
      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    html,body{height:100%}
    body{
      background:
        radial-gradient(1000px 650px at 14% 10%, rgba(247,215,116,.14), transparent 62%),
        radial-gradient(900px 600px at 88% 0%, rgba(201,162,74,.12), transparent 60%),
        radial-gradient(1000px 760px at 50% 105%, rgba(99,102,241,.12), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:#fff; overflow-x:hidden;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    *{box-sizing:border-box}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .glass{background:linear-gradient(180deg, var(--glassA), var(--glassB)); border:1px solid var(--stroke); box-shadow:var(--shadow); backdrop-filter:blur(10px);}
    .glass-soft{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.025)); border:1px solid rgba(255,255,255,.09); box-shadow:var(--shadow2); backdrop-filter:blur(10px);}
    .gold-border{border:1px solid rgba(247,215,116,.34); box-shadow:0 0 0 1px rgba(201,162,74,.18) inset;}
    .gold-text{background:linear-gradient(90deg, var(--gold1), var(--gold2)); -webkit-background-clip:text; background-clip:text; color:transparent;}
    .chip{border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.05);}
    .btn-gold{background:linear-gradient(90deg, rgba(247,215,116,1), rgba(201,162,74,1)); color:#111827; box-shadow:0 12px 34px rgba(247,215,116,.18); transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;}
    .btn-gold:hover{filter:brightness(1.03); transform:translateY(-1px)}
    .btn-gold:active{transform:translateY(0)}
    .btn-gold:disabled,.chip:disabled{opacity:.45; cursor:not-allowed; box-shadow:none; transform:none}
    .focus-ring:focus{outline:none; box-shadow:0 0 0 3px rgba(247,215,116,.25)}
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid rgba(255,255,255,.10);}
    .bar>div{height:100%;border-radius:999px;background:linear-gradient(90deg, rgba(247,215,116,1), rgba(201,162,74,1));width:0%;transition:width .35s ease;}
    .safe-pb{padding-bottom:env(safe-area-inset-bottom)}
    .kbd{border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); padding:.15rem .45rem; border-radius:.5rem; font-size:.72rem;}
    .dot{width:.55rem;height:.55rem;border-radius:999px;display:inline-block}
    .dot.good{background:var(--good); box-shadow:0 0 0 3px rgba(34,197,94,.14)}
    .dot.warn{background:var(--warn); box-shadow:0 0 0 3px rgba(245,158,11,.14)}
    .dot.bad{background:var(--bad); box-shadow:0 0 0 3px rgba(239,68,68,.14)}
  </style>
</head>

<body class="min-h-screen safe-pb">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-8 sm:py-10">

    <!-- Top strip -->
    <div class="flex items-center justify-between gap-3 mb-6">
      <div class="inline-flex items-center gap-2 chip px-3 py-1.5 rounded-full text-xs">
        <i class="fa-solid fa-shield-halved"></i>
        <span class="opacity-90">Public Beta</span>
        <span class="opacity-40">‚Ä¢</span>
        <span class="opacity-80"><span id="waitlistCountBadge">0</span> early access sign-ups</span>
      </div>
      <div class="hidden sm:flex items-center gap-2 text-xs muted">
        <span id="liveActivity"></span>
      </div>
    </div>

    <!-- HERO -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-6 items-stretch">
      <div class="lg:col-span-7 glass gold-border rounded-3xl p-6 sm:p-8">
        <div class="flex flex-wrap items-center gap-2">
          <span class="chip rounded-full px-3 py-1 text-xs"><i class="fa-solid fa-bolt mr-1"></i>Instant report</span>
          <span class="chip rounded-full px-3 py-1 text-xs"><i class="fa-solid fa-lock mr-1"></i>Privacy-first</span>
          <span class="chip rounded-full px-3 py-1 text-xs"><i class="fa-solid fa-globe mr-1"></i>Global anti-scam</span>
        </div>

        <h1 class="mt-5 text-3xl sm:text-4xl md:text-6xl font-extrabold leading-tight tracking-tight">

  <span class="gold-text">VoiceSafe</span>

  <span class="block mt-3">
    Detect AI Voice Fraud
    <span class="gold-text">Before It Costs You Everything</span>
  </span>

  <span class="block mt-4 text-lg sm:text-xl font-medium text-white/70 max-w-2xl">
    Enterprise-grade AI analysis that exposes voice cloning,
    impersonation scams and social-engineering attacks in seconds.
  </span>

</h1>

<!-- TRUST BAR (viral + investor proof) -->
<div class="mt-5 flex flex-col gap-3">

  <!-- Proof chips -->
  <div class="flex flex-wrap gap-2 text-xs">
    <span class="chip rounded-full px-3 py-1">
      <i class="fa-solid fa-shield-halved mr-1"></i> Enterprise-grade risk scoring
    </span>
    <span class="chip rounded-full px-3 py-1">
      <i class="fa-solid fa-lock mr-1"></i> Privacy-first (no permanent storage)
    </span>
    <span class="chip rounded-full px-3 py-1">
      <i class="fa-solid fa-scale-balanced mr-1"></i> GDPR-ready posture (EU-first)
    </span>
    <span class="chip rounded-full px-3 py-1">
      <i class="fa-solid fa-bolt mr-1"></i> Results in seconds
    </span>
  </div>

  <!-- Mini metrics -->
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
    <div class="chip rounded-2xl p-3">
      <div class="text-[11px] muted">Avg. report time</div>
      <div class="mt-1 text-lg font-extrabold"><span class="gold-text">~8s</span></div>
    </div>
    <div class="chip rounded-2xl p-3">
      <div class="text-[11px] muted">Signals analyzed</div>
      <div class="mt-1 text-lg font-extrabold"><span class="gold-text">40+</span></div>
    </div>
    <div class="chip rounded-2xl p-3">
      <div class="text-[11px] muted">Built for</div>
      <div class="mt-1 text-lg font-extrabold"><span class="gold-text">Banks</span></div>
    </div>
    <div class="chip rounded-2xl p-3">
      <div class="text-[11px] muted">And for</div>
      <div class="mt-1 text-lg font-extrabold"><span class="gold-text">Everyone</span></div>
    </div>
  </div>

</div>

        <p class="mt-4 text-base sm:text-lg muted max-w-2xl">
          Upload or record a short clip. VoiceSafe returns a risk report:
          <span class="text-white/90 font-semibold">scam score</span>,
          <span class="text-white/90 font-semibold">AI probability</span>,
          <span class="text-white/90 font-semibold">stress signals</span>, and
          <span class="text-white/90 font-semibold">red flags</span>.
        </p>

        <div class="mt-6 flex flex-wrap gap-3">
          <button id="ctaAnalyze" class="btn-gold rounded-xl px-5 py-3 text-sm font-extrabold">
            <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Analyze now
          </button>
          <button id="ctaDemo" class="chip rounded-xl px-5 py-3 text-sm font-semibold hover:opacity-90">
            <i class="fa-solid fa-play mr-2"></i>Investor demo
          </button>
          <button id="ctaHow" class="chip rounded-xl px-5 py-3 text-sm font-semibold hover:opacity-90">
            <i class="fa-solid fa-circle-info mr-2"></i>How it works
          </button>
          <button id="installBtn" class="chip rounded-xl px-5 py-3 text-sm font-semibold hover:opacity-90 hidden">
            <i class="fa-solid fa-download mr-2"></i>Install app
          </button>
        </div>

        <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm">
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Free analyses</div>
            <div class="mt-1 text-xl font-bold" id="freeLimitLabel">3</div>
            <div class="mt-1 text-xs muted" id="usageLabel">Used: 0/3</div>
          </div>
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Privacy posture</div>
            <div class="mt-1 text-xl font-bold">No voice storage</div>
            <div class="mt-1 text-xs muted">Prototype mode</div>
          </div>
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Compliance-ready</div>
            <div class="mt-1 text-xl font-bold">GDPR posture</div>
            <div class="mt-1 text-xs muted">EU-first approach</div>
          </div>
        </div>

        <div class="mt-6 text-xs muted">
          Early access sign-ups: <span id="waitlistCountTop" class="text-white/90 font-semibold">0</span>
          <span class="opacity-40">‚Ä¢</span>
          <span class="kbd">Tip:</span> Press <span class="kbd">D</span> for demo
          <span class="opacity-40">‚Ä¢</span>
          <span class="kbd">Tip:</span> Press <span class="kbd">?</span> for diagnostics
        </div>
      </div>

      <!-- Backend status -->
      <div class="lg:col-span-5 glass gold-border rounded-3xl p-6 sm:p-7">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="text-sm font-semibold">System status</div>
            <div class="text-xs muted truncate mt-1" id="backendStatus">Checking‚Ä¶</div>
          </div>
          <div class="text-right shrink-0">
            <div class="text-xs muted">Mode</div>
            <div class="text-sm font-semibold gold-text" id="modeLabel">PROD</div>
          </div>
        </div>

        <div class="mt-3 text-xs muted break-all">
          <span class="mono" id="backendUrl"></span>
        </div>

        <div class="mt-4 grid grid-cols-2 gap-2">
          <button id="btnProd" class="chip rounded-xl px-3 py-2 text-xs font-semibold hover:opacity-90">PROD</button>
          <button id="btnLocal" class="chip rounded-xl px-3 py-2 text-xs font-semibold hover:opacity-90">LOCAL</button>
        </div>

        <div class="mt-6 grid grid-cols-1 gap-3">
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">What VoiceSafe checks</div>
            <div class="mt-2 flex flex-wrap gap-2 text-xs">
              <span class="chip rounded-full px-3 py-1">AI voice patterns</span>
              <span class="chip rounded-full px-3 py-1">Impersonation markers</span>
              <span class="chip rounded-full px-3 py-1">Urgency / pressure</span>
              <span class="chip rounded-full px-3 py-1">Financial request signals</span>
            </div>
          </div>

          <button id="joinWaitlistBtn" class="chip rounded-2xl p-4 text-left hover:opacity-90">
            <div class="text-sm font-semibold"><i class="fa-solid fa-fire mr-2"></i>Join early access</div>
            <div class="mt-1 text-xs muted">Shows demand to investors + prioritizes roadmap.</div>
          </button>

          <div class="glass-soft rounded-2xl p-4">
            <div class="text-sm font-semibold">Trust posture</div>
            <div class="mt-2 text-xs muted leading-6">
              VoiceSafe is an <span class="text-white/90 font-semibold">early warning system</span>.
              Always verify identity via an <span class="text-white/90 font-semibold">official contact</span> before sending money.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div id="analyzer" class="mt-6 sm:mt-8 grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-6 items-start">
      <!-- LEFT -->
      <div class="lg:col-span-5 glass rounded-3xl p-5 sm:p-6">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold">Analyze a sample</h2>
            <p class="muted text-sm mt-1">Upload audio/video or record a short clip.</p>
          </div>
          <button id="demoBtn" class="chip rounded-xl px-3 py-2 text-xs font-semibold hover:opacity-90">‚ö° Demo</button>
        </div>

        <div class="mt-5">
          <label class="block text-sm muted mb-2" for="fileInput">Upload file</label>
          <input id="fileInput" type="file" accept="audio/*,video/*" class="w-full text-sm chip rounded-xl p-3 outline-none focus-ring" />
          <div class="mt-2 text-xs muted" id="fileHint">No file selected.</div>
          <div class="mt-2 text-[11px] muted" id="sizeHint"></div>
        </div>

        <div class="mt-5 grid grid-cols-2 gap-3">
          <button id="recordBtn" type="button" class="chip rounded-xl px-4 py-3 text-sm font-semibold hover:opacity-90">
            <i class="fa-solid fa-microphone mr-2"></i>Record
          </button>
          <button id="analyzeBtn" class="btn-gold rounded-xl px-4 py-3 text-sm font-extrabold" disabled>
            <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Analyze
          </button>
        </div>

        <div class="mt-6 border-t border-white/10 pt-5">
          <h3 class="text-sm font-semibold">Case details (optional)</h3>
          <p class="muted text-xs mt-1">Saved cases can be searched & shared (if backend supports it).</p>

          <div class="mt-4 space-y-3">
            <input id="title" class="w-full chip rounded-xl p-3 text-sm outline-none focus-ring" placeholder="Title (e.g. Telegram investor)" />
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <input id="platform" class="w-full chip rounded-xl p-3 text-sm outline-none focus-ring" placeholder="Platform (Telegram)" />
              <input id="country" class="w-full chip rounded-xl p-3 text-sm outline-none focus-ring" placeholder="Country (US)" />
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <input id="language" class="w-full chip rounded-xl p-3 text-sm outline-none focus-ring" placeholder="Language (EN)" />
              <input id="tags" class="w-full chip rounded-xl p-3 text-sm outline-none focus-ring" placeholder="Tags (comma separated)" />
            </div>
            <textarea id="notes" rows="3" class="w-full chip rounded-xl p-3 text-sm outline-none focus-ring" placeholder="Notes (what happened)"></textarea>
          </div>

          <div class="mt-4 text-xs muted">Tip: Keep personal data out of notes.</div>
        </div>

        <div class="mt-5 chip rounded-2xl p-4 text-xs muted">
          <div class="font-semibold text-white/90">Disclaimer</div>
          <div class="mt-1">Scores are prototypes and can be wrong. Always verify identity using official channels.</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div id="resultsCard" class="lg:col-span-7 glass rounded-3xl p-5 sm:p-6">
        <div class="text-xs muted tracking-widest uppercase">AI Risk Assessment Report</div>

        <div class="mt-2 flex flex-col md:flex-row md:items-start md:justify-between gap-4">
          <div class="min-w-0">
            <h2 class="text-2xl font-extrabold">Results</h2>
            <p class="muted text-sm mt-1" id="resultsSub">Upload or record to generate a report.</p>
          </div>

          <div class="flex items-center gap-2 flex-wrap">
            <button id="copyJsonBtn" class="chip rounded-xl px-4 py-2 text-sm font-semibold hover:opacity-90" disabled>
              <i class="fa-regular fa-copy mr-2"></i>Copy JSON
            </button>
            <button id="shareBtn" class="chip rounded-xl px-4 py-2 text-sm font-semibold hover:opacity-90" disabled>
              <i class="fa-solid fa-link mr-2"></i>Share
            </button>
            <button id="upgradeBtn" class="btn-gold rounded-xl px-4 py-2 text-sm font-extrabold">üöÄ Unlock Pro ‚Äì ‚Ç¨9/month</button>
            <button id="manageSubBtn" class="chip rounded-xl px-4 py-2 text-sm hover:opacity-90">Manage subscription</button>
          </div>
        </div>

        <!-- Request status -->
        <div class="mt-4 chip rounded-2xl p-4 text-xs flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="text-[11px] muted">Request status</div>
            <div class="mt-1 flex items-center gap-2">
              <span id="reqDot" class="dot warn"></span>
              <span id="reqStatus" class="text-white/90">Idle</span>
            </div>
            <div class="mt-1 text-[11px] muted mono break-all" id="reqId">req_‚Äî</div>
          </div>
          <div class="text-right">
            <div class="text-[11px] muted">Latency</div>
            <div class="mt-1 mono text-white/90" id="latencyMs">‚Äî</div>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Scam score</div>
            <div class="mt-1 text-3xl font-extrabold"><span id="scamScore">‚Äî</span><span class="text-base muted">%</span></div>
            <div class="mt-3 bar"><div id="scamBar"></div></div>
          </div>
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">AI voice probability</div>
            <div class="mt-1 text-3xl font-extrabold"><span id="aiProb">‚Äî</span><span class="text-base muted">%</span></div>
            <div class="mt-3 bar"><div id="aiBar"></div></div>
          </div>
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Stress level</div>
            <div class="mt-1 text-3xl font-extrabold"><span id="stressLevel">‚Äî</span><span class="text-base muted">%</span></div>
            <div class="mt-3 bar"><div id="stressBar"></div></div>
          </div>
        </div>

        <div class="mt-5 chip rounded-2xl p-5">
          <div class="text-xs muted">Summary</div>
          <div class="mt-2 text-slate-100 text-sm sm:text-base" id="summaryText">Upload or record a sample to see results.</div>
          <div class="mt-3 flex flex-wrap gap-2" id="flagsWrap"></div>
        </div>

        <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="chip rounded-2xl p-5">
            <div class="text-sm font-semibold">Saved case</div>
            <div class="mt-2 text-xs muted">Case ID</div>
            <div class="mt-1 mono text-sm break-all" id="caseId">‚Äî</div>
            <div class="mt-3 text-xs muted" id="caseSavedHint">Analyze a sample to create a case.</div>
          </div>

          <div class="chip rounded-2xl p-5">
            <div class="text-sm font-semibold">Search cases</div>
            <div class="mt-3 flex gap-2">
              <input id="searchQ" class="flex-1 chip rounded-xl p-3 text-sm outline-none focus-ring min-w-0" placeholder="Search title / notes..." />
              <button id="searchBtn" class="btn-gold rounded-xl px-4 py-3 text-sm font-extrabold shrink-0">Search</button>
            </div>
            <div class="mt-3 flex gap-2">
              <input id="searchTag" class="flex-1 chip rounded-xl p-3 text-sm outline-none focus-ring min-w-0" placeholder="Tag filter (optional)" />
              <button id="clearBtn" class="chip rounded-xl px-4 py-3 text-sm font-semibold hover:opacity-90 shrink-0">Clear</button>
            </div>
            <div class="mt-4 pr-1 overflow-auto" id="resultsList" style="max-height:min(46vh,360px);"></div>
          </div>
        </div>

        <pre class="mt-5 chip rounded-2xl p-4 text-xs overflow-auto hidden" id="rawJson" style="max-height:min(40vh,320px);"></pre>
      </div>
    </div>

    <div class="mt-10 text-center text-xs muted">
      VoiceSafe ‚Ä¢ Prototype ‚Ä¢ Built for global anti-scam awareness ‚Ä¢ <span class="mono">voicesafe.ai</span>
    </div>
  </div>

  <!-- HOW MODAL -->
  <div id="howModal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div id="howBackdrop" class="absolute inset-0 bg-black/60"></div>
    <div class="relative w-[92%] max-w-2xl rounded-3xl border border-white/10 bg-[#0b0f14] p-6 sm:p-7 shadow-xl">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-xl font-extrabold">How VoiceSafe works</h3>
          <p class="mt-1 text-sm muted">Clear output, fast workflow, minimal friction.</p>
        </div>
        <button id="howClose" class="rounded-xl px-3 py-2 text-sm chip hover:opacity-90">‚úï</button>
      </div>
      <div class="mt-5 grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm">
        <div class="chip rounded-2xl p-4"><div class="text-xs muted">1) Input</div><div class="mt-1 font-semibold">Upload or record</div><div class="mt-1 text-xs muted">Audio/video supported</div></div>
        <div class="chip rounded-2xl p-4"><div class="text-xs muted">2) Analysis</div><div class="mt-1 font-semibold">Risk scoring</div><div class="mt-1 text-xs muted">Signals + probabilities</div></div>
        <div class="chip rounded-2xl p-4"><div class="text-xs muted">3) Action</div><div class="mt-1 font-semibold">Verify + report</div><div class="mt-1 text-xs muted">Use official channels</div></div>
      </div>
      <div class="mt-5 text-sm muted leading-6">
        VoiceSafe is a prototype. Scores can be wrong ‚Äî treat the report as an early warning system.
        When money is involved, always verify the caller via trusted, official contact methods.
      </div>
      <div class="mt-6 flex flex-col sm:flex-row gap-2">
        <button id="howTryDemo" class="btn-gold rounded-xl px-4 py-3 text-sm font-extrabold w-full sm:w-auto"><i class="fa-solid fa-play mr-2"></i>Load investor demo</button>
        <button id="howGoAnalyze" class="chip rounded-xl px-4 py-3 text-sm font-semibold hover:opacity-90 w-full sm:w-auto"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Go to analyzer</button>
      </div>
    </div>
  </div>

  <!-- PAYWALL MODAL -->
  <div id="paywallModal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div id="paywallBackdrop" class="absolute inset-0 bg-black/60"></div>
    <div class="relative w-[92%] max-w-lg rounded-3xl border border-white/10 bg-[#0b0f14] p-6 shadow-xl">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-xl font-extrabold">Free limit reached</h3>
          <p class="mt-1 text-sm muted">Upgrade to Pro to continue analyzing.</p>
        </div>
        <button id="paywallClose" class="rounded-xl px-3 py-2 text-sm chip hover:opacity-90">‚úï</button>
      </div>
      <div class="mt-4 grid gap-2 text-sm opacity-90">
        <div>‚úì Unlimited analyses</div>
        <div>‚úì Priority processing</div>
        <div>‚úì Case history & sharing</div>
      </div>
      <div class="mt-6 flex flex-col gap-2">
        <button id="paywallCta" class="btn-gold rounded-xl px-4 py-3 text-sm font-extrabold w-full">Start Pro ‚Äì ‚Ç¨9/month</button>
        <button id="paywallWaitlist" class="chip rounded-xl px-4 py-3 text-sm font-semibold hover:opacity-90 w-full">Join early access</button>
        <p class="mt-2 text-xs muted">This flow is optimized for conversion + investor demo.</p>
        <p id="waitlistCountText" class="mt-1 text-xs muted text-center"></p>
      </div>
    </div>
  </div>

  <!-- DIAGNOSTICS MODAL -->
  <div id="diagModal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div id="diagBackdrop" class="absolute inset-0 bg-black/60"></div>
    <div class="relative w-[92%] max-w-2xl rounded-3xl border border-white/10 bg-[#0b0f14] p-6 sm:p-7 shadow-xl">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-xl font-extrabold">Diagnostics</h3>
          <p class="mt-1 text-sm muted">Use this when ‚ÄúAnalyze failed‚Äù.</p>
        </div>
        <button id="diagClose" class="rounded-xl px-3 py-2 text-sm chip hover:opacity-90">‚úï</button>
      </div>

      <div class="mt-5 grid gap-3 text-sm">
        <div class="chip rounded-2xl p-4">
          <div class="text-xs muted">Backend</div>
          <div class="mt-1 mono break-all" id="diagBackend">‚Äî</div>
          <div class="mt-2 text-xs muted" id="diagBackendHealth">‚Äî</div>
        </div>

        <div class="chip rounded-2xl p-4">
          <div class="text-xs muted">Most recent error</div>
          <pre class="mt-2 text-xs overflow-auto" style="max-height:220px" id="diagLastError">‚Äî</pre>
        </div>

        <div class="flex flex-wrap gap-2">
          <button id="diagRecheck" class="btn-gold rounded-xl px-4 py-3 text-sm font-extrabold">
            <i class="fa-solid fa-stethoscope mr-2"></i>Re-check health
          </button>
          <button id="diagCopy" class="chip rounded-xl px-4 py-3 text-sm font-semibold hover:opacity-90">
            <i class="fa-regular fa-copy mr-2"></i>Copy diagnostics
          </button>
          <button id="diagReset" class="chip rounded-xl px-4 py-3 text-sm font-semibold hover:opacity-90">
            <i class="fa-solid fa-rotate mr-2"></i>Reset local state
          </button>
        </div>

        <div class="text-xs muted leading-6">
          If health is OK but analyze fails: likely CORS, backend route mismatch (<span class="mono">/upload</span>),
          or backend isn‚Äôt forwarding to AI.
        </div>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden z-[60]">
    <div class="chip gold-border rounded-2xl px-4 py-3 text-sm shadow-xl">
      <span id="toastMsg"></span>
    </div>
  </div>

  <script>
  (function(){
    "use strict";
    if (window.__VS_BOOTED__) return;
    window.__VS_BOOTED__ = true;

    // ==========================
    // CONFIG (clean URLs only)
    // ==========================
    const CFG = {
      URLS: Object.freeze({
        PROD: { BACKEND: "https://voicesafe-backend-1.onrender.com", AI: "https://voicesafe-ai.onrender.com" },
        LOCAL: { BACKEND: "http://127.0.0.1:10000", AI: "http://127.0.0.1:8000" }
      }),
      STRIPE: Object.freeze({
        CHECKOUT_URL: "https://buy.stripe.com/aFa3cn42A8Iq1cC8m2gA800",
        BILLING_PORTAL_URL: ""
      }),
      POLICY: Object.freeze({
        FREE_LIMIT: 3,
        MAX_UPLOAD_MB: 25,
        TIMEOUT_MS: 120000,
        HEALTH_TIMEOUT_MS: 12000,
        UI_MIN_SPINNER_MS: 700,
        RETRY_ON_NETWORK: 1
      })
    };

    // ==========================
    // Helpers
    // ==========================
    const $ = (id) => document.getElementById(id);
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const clampPct = (v) => clamp(Number(v)||0, 0, 100);
    const nowMs = () => (performance && performance.now) ? performance.now() : Date.now();

    function toast(msg){
      const t = $("toast"), m = $("toastMsg");
      if (!t || !m) return;
      m.textContent = msg;
      t.classList.remove("hidden");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => t.classList.add("hidden"), 2200);
    }
    function setBars(scam, ai, stress){
      $("scamBar") && ($("scamBar").style.width = clampPct(scam) + "%");
      $("aiBar") && ($("aiBar").style.width = clampPct(ai) + "%");
      $("stressBar") && ($("stressBar").style.width = clampPct(stress) + "%");
    }
    function setReqState(text, kind){
      $("reqStatus") && ($("reqStatus").textContent = text || "Idle");
      const dot = $("reqDot");
      if (dot) dot.className = "dot " + (kind || "warn");
    }
    function setLatency(ms){
      $("latencyMs") && ($("latencyMs").textContent = Number.isFinite(ms) ? `${Math.round(ms)}ms` : "‚Äî");
    }
    function genReqId(){
      return "req_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function pickNumber(obj, keys, fallback=0){
      for (const k of keys){
        const val = obj?.[k];
        if (val === undefined || val === null || val === "") continue;
        const n = Number(val);
        if (Number.isFinite(n)) return n;
      }
      return fallback;
    }
    function pickText(obj, keys, fallback=""){
      for (const k of keys){
        const val = obj?.[k];
        if (typeof val === "string" && val.trim()) return val.trim();
      }
      return fallback;
    }
    function normalizeFlags(flags){
      if (!flags) return [];
      if (Array.isArray(flags)) return flags.filter(Boolean).slice(0, 12);
      if (typeof flags === "string") return flags.split(",").map(s => s.trim()).filter(Boolean).slice(0, 12);
      return [];
    }
    function showRaw(obj){
      const raw = $("rawJson");
      if (!raw) return;
      raw.textContent = JSON.stringify(obj, null, 2);
      raw.classList.remove("hidden");
    }
    function hideRaw(){
      const raw = $("rawJson");
      if (!raw) return;
      raw.textContent = "";
      raw.classList.add("hidden");
    }

    // ==========================
    // Local state
    // ==========================
    const LS = {
      getMode(){
        const urlMode = (new URL(location.href).searchParams.get("mode") || "").toUpperCase();
        if (urlMode === "LOCAL" || urlMode === "PROD") { localStorage.setItem("vs_mode", urlMode); return urlMode; }
        const m = (localStorage.getItem("vs_mode") || "").toUpperCase();
        return (m === "LOCAL") ? "LOCAL" : "PROD";
      },
      setMode(m){ localStorage.setItem("vs_mode", m); },
      isPro(){ return localStorage.getItem("voicesafe_pro") === "true"; },
      demoMode(){ return localStorage.getItem("vs_demo") === "true"; },
      usage(){ return Number(localStorage.getItem("vs_usage") || 0); },
      setUsage(n){ localStorage.setItem("vs_usage", String(Math.max(0, Number(n)||0))); },
      customerId(){ return localStorage.getItem("voicesafe_customer_id") || ""; },
      setCustomerId(v){ if (v) localStorage.setItem("voicesafe_customer_id", v); }
    };

    // ==========================
    // Mode + endpoints
    // ==========================
    let mode = LS.getMode();
    let backendBase = CFG.URLS[mode].BACKEND.replace(/\/+$/,"");
    let lastResponse = null;
    let lastCaseId = null;
    let lastErrorObj = null;
    let progressTimer = null;

    function applyModeUI(){
      $("modeLabel") && ($("modeLabel").textContent = mode);
      $("backendUrl") && ($("backendUrl").textContent = backendBase);
    }

    // ==========================
    // Enterprise fetch (timeout + retries)
    // ==========================
    function withTimeout(ms){
      const c = new AbortController();
      const t = setTimeout(() => c.abort(), ms);
      return { signal: c.signal, done: () => clearTimeout(t) };
    }
    async function readJsonOrText(resp){
      const text = await resp.text().catch(() => "");
      if (!text) return null;
      try { return JSON.parse(text); } catch { return { raw: text }; }
    }
    async function request(url, opts){
      const reqId = genReqId();
      $("reqId") && ($("reqId").textContent = reqId);

      const timeout = opts?.timeoutMs ?? CFG.POLICY.TIMEOUT_MS;
      const retries = opts?.retries ?? 0;
      let attempt = 0;
      let lastErr = null;

      while (attempt <= retries){
        attempt++;
        const t0 = nowMs();
        const { signal, done } = withTimeout(timeout);

        try{
          const headers = Object.assign({}, opts?.headers || {}, { "x-request-id": reqId });
          const res = await fetch(url, { ...opts, headers, signal });
          done();

          const body = await readJsonOrText(res);
          const latency = nowMs() - t0;
          setLatency(latency);

          if (!res.ok){
            const msg = body?.message || body?.error || body?.raw || `HTTP ${res.status}`;
            const err = new Error(msg);
            err.status = res.status;
            err.data = body;
            err.reqId = reqId;
            err.url = url;
            throw err;
          }
          return { ok:true, reqId, data: body ?? {} };
        } catch(e){
          done();
          lastErr = e;
          lastErr.reqId = lastErr.reqId || reqId;
          lastErr.url = lastErr.url || url;

          const isAbort = (e?.name === "AbortError");
          const isNetwork = (!("status" in e) && !isAbort) || (String(e?.message||"").toLowerCase().includes("failed to fetch"));
          const shouldRetry = (attempt <= retries) && (isAbort || isNetwork);

          if (shouldRetry){
            await sleep(250 + attempt * 250);
            continue;
          }
          throw lastErr;
        }
      }
      throw lastErr || new Error("unknown_error");
    }

    async function health(){
      const r = await request(`${backendBase}/health`, { method:"GET", cache:"no-store", timeoutMs: CFG.POLICY.HEALTH_TIMEOUT_MS, retries:0 });
      return r.data || {};
    }
    async function upload(formData){
      const r = await request(`${backendBase}/upload`, { method:"POST", body: formData, timeoutMs: CFG.POLICY.TIMEOUT_MS, retries: CFG.POLICY.RETRY_ON_NETWORK });
      return r.data || {};
    }
    async function searchCases(q, tag){
      const u = new URL(`${backendBase}/cases`);
      if (q) u.searchParams.set("q", q);
      if (tag) u.searchParams.set("tag", tag);
      const r = await request(u.toString(), { method:"GET", cache:"no-store", timeoutMs: CFG.POLICY.HEALTH_TIMEOUT_MS, retries:0 });
      return r.data || {};
    }
    async function loadCase(id){
      const r = await request(`${backendBase}/case/${encodeURIComponent(id)}`, { method:"GET", cache:"no-store", timeoutMs: CFG.POLICY.HEALTH_TIMEOUT_MS, retries:0 });
      return r.data || {};
    }
    async function createPortal(customerId){
      const r = await request(`${backendBase}/create-portal-session`, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ customerId }),
        timeoutMs: CFG.POLICY.HEALTH_TIMEOUT_MS,
        retries:0
      });
      return r.data || {};
    }
    async function verifySession(sessionId){
      const r = await request(`${backendBase}/verify-session?session_id=${encodeURIComponent(sessionId)}`, { method:"GET", cache:"no-store", timeoutMs: CFG.POLICY.HEALTH_TIMEOUT_MS, retries:0 });
      return r.data || {};
    }

    // ==========================
    // UI rendering
    // ==========================
    function renderUsage(){
      const limit = Number(CFG.POLICY.FREE_LIMIT || 3);
      $("freeLimitLabel") && ($("freeLimitLabel").textContent = String(limit));
      const u = LS.usage();
      if (LS.isPro()) $("usageLabel") && ($("usageLabel").textContent = "PRO active ‚Ä¢ Unlimited");
      else $("usageLabel") && ($("usageLabel").textContent = `Used: ${u}/${limit}`);
    }
    function renderWaitlist(){
      const count = Number(localStorage.getItem("waitlist") || 0);
      $("waitlistCountTop") && ($("waitlistCountTop").textContent = String(count));
      $("waitlistCountBadge") && ($("waitlistCountBadge").textContent = String(count));
      $("waitlistCountText") && ($("waitlistCountText").textContent = `Total early access sign-ups: ${count}`);
    }
    function joinWaitlist(){
      const count = Number(localStorage.getItem("waitlist") || 0) + 1;
      localStorage.setItem("waitlist", String(count));
      renderWaitlist();
      toast("Joined early access ‚úì");
    }
    function renderResult(payload){
      const data = payload?.aiResult ? payload.aiResult : payload || {};
      const scam = pickNumber(data, ["scam_score","scamScore","risk","risk_score"], 0);
      const ai = pickNumber(data, ["ai_probability","aiProb","ai_voice_prob","ai_voice_probability","aiVoiceProbability"], 0);
      const stress = pickNumber(data, ["stress_level","stressLevel","stress_score"], 0);
      const summary = pickText(data, ["summary","message","explanation"], "Analysis complete.");
      const flags = normalizeFlags(data.flags || data.signals || data.red_flags || data.redFlags);

      $("scamScore") && ($("scamScore").textContent = String(Math.round(clampPct(scam))));
      $("aiProb") && ($("aiProb").textContent = String(Math.round(clampPct(ai))));
      $("stressLevel") && ($("stressLevel").textContent = String(Math.round(clampPct(stress))));
      $("summaryText") && ($("summaryText").textContent = summary);

      const wrap = $("flagsWrap");
      if (wrap){
        wrap.innerHTML = "";
        flags.forEach(f => {
          const chip = document.createElement("span");
          chip.className = "chip rounded-full px-3 py-1 text-xs";
          chip.textContent = f;
          wrap.appendChild(chip);
        });
      }

      setBars(scam, ai, stress);
      $("copyJsonBtn") && ($("copyJsonBtn").disabled = false);
    }
    function resetUI(){
      $("scamScore") && ($("scamScore").textContent = "‚Äî");
      $("aiProb") && ($("aiProb").textContent = "‚Äî");
      $("stressLevel") && ($("stressLevel").textContent = "‚Äî");
      $("summaryText") && ($("summaryText").textContent = "Upload or record a sample to see results.");
      $("flagsWrap") && ($("flagsWrap").innerHTML = "");
      setBars(0,0,0);
      setReqState("Idle","warn");
      setLatency(NaN);
      $("copyJsonBtn") && ($("copyJsonBtn").disabled = true);
      $("shareBtn") && ($("shareBtn").disabled = true);
      $("caseId") && ($("caseId").textContent = "‚Äî");
      $("caseSavedHint") && ($("caseSavedHint").textContent = "Analyze a sample to create a case.");
      hideRaw();
    }

    // ==========================
    // Modals
    // ==========================
    function openModal(id){ const m = $(id); if (!m) return; m.classList.remove("hidden"); m.classList.add("flex"); }
    function closeModal(id){ const m = $(id); if (!m) return; m.classList.add("hidden"); m.classList.remove("flex"); }

    // ==========================
    // Health
    // ==========================
    async function checkHealth(){
      try{
        const j = await health();
        const aiOk = (j.ai_ok === true) ? "true" : String(j.ai_ok ?? "n/a");
        $("backendStatus") && ($("backendStatus").textContent = `OK ‚Ä¢ AI_OK: ${aiOk} ‚Ä¢ max_upload_mb: ${String(j.max_upload_mb ?? "n/a")}`);
      } catch(e){
        $("backendStatus") && ($("backendStatus").textContent = "Offline / blocked (check URL, CORS, or server)");
        lastErrorObj = e;
      }
    }

    // ==========================
    // Demo
    // ==========================
    function loadDemo(){
      localStorage.setItem("vs_demo","true");
      const demo = {
        scam_score: 82,
        ai_probability: 91,
        stress_level: 67,
        summary: "High likelihood of AI-generated impersonation with financial manipulation intent. Verify identity through an official number before sending money.",
        flags: [
          "AI voice synthesis detected (demo)",
          "Urgency / pressure language (demo)",
          "Financial request pattern (demo)",
          "Emotional manipulation markers (demo)",
          "Call-flow inconsistency (demo)"
        ]
      };
      renderResult(demo);
      lastResponse = demo;
      showRaw({ demo:true, sample: demo });
      toast("Investor demo loaded ‚úì");
      $("resultsCard")?.scrollIntoView({ behavior:"smooth", block:"start" });
    }

    // ==========================
    // Recording
    // ==========================
    let mediaRecorder = null;
    let recordedChunks = [];
    let recording = false;

    function stopTracks(stream){ try{ stream?.getTracks?.().forEach(t=>t.stop()); }catch{} }

    async function toggleRecord(){
      const btn = $("recordBtn");
      const fileInput = $("fileInput");
      const fileHint = $("fileHint");

      try{
        if (!recording){
          const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
          recordedChunks = [];
          mediaRecorder = new MediaRecorder(stream);

          mediaRecorder.ondataavailable = (e) => { if (e.data && e.data.size > 0) recordedChunks.push(e.data); };
          mediaRecorder.onstop = () => {
            try{
              const blob = new Blob(recordedChunks, { type:"audio/webm" });
              const file = new File([blob], "mic.webm", { type:"audio/webm" });
              const dt = new DataTransfer();
              dt.items.add(file);
              fileInput.files = dt.files;
              if (fileHint) fileHint.textContent = `Recorded: ${file.name} (${Math.round(file.size/1024)} KB)`;
              updateAnalyzeEnabled();
              toast("Recording saved ‚úì");
            } catch { toast("Could not finalize recording."); }
            finally { stopTracks(stream); }
          };

          mediaRecorder.start();
          recording = true;
          if (btn) btn.innerHTML = `<i class="fa-solid fa-stop mr-2"></i>Stop`;
          toast("Recording‚Ä¶");
        } else {
          mediaRecorder.stop();
          recording = false;
          if (btn) btn.innerHTML = `<i class="fa-solid fa-microphone mr-2"></i>Record`;
        }
      } catch {
        alert("Microphone permission blocked or unavailable.");
      }
    }

    // ==========================
    // Analyze
    // ==========================
    function updateAnalyzeEnabled(){
      const f = $("fileInput")?.files?.[0];
      $("analyzeBtn") && ($("analyzeBtn").disabled = !f);
    }

    async function analyze(){
      const f = $("fileInput")?.files?.[0];

      const limit = Number(CFG.POLICY.FREE_LIMIT || 3);
      if (!LS.isPro() && !LS.demoMode() && LS.usage() >= limit){
        openModal("paywallModal");
        renderWaitlist();
        return;
      }

      if (!f){
        toast("Select a file or record audio first.");
        return;
      }

      const maxBytes = (Number(CFG.POLICY.MAX_UPLOAD_MB||25) * 1024 * 1024);
      if (f.size > maxBytes){
        toast(`File too large for target UX (~${CFG.POLICY.MAX_UPLOAD_MB}MB). Server may reject.`);
      }

      const steps = [
        "Uploading sample‚Ä¶","Analyzing voice pattern‚Ä¶","Detecting AI voice cloning‚Ä¶",
        "Measuring stress markers‚Ä¶","Scanning scam signals‚Ä¶","Finalizing report‚Ä¶"
      ];
      let stepIndex = 0;

      $("summaryText") && ($("summaryText").textContent = steps[0]);
      if (progressTimer) clearInterval(progressTimer);
      progressTimer = setInterval(() => {
        stepIndex = Math.min(stepIndex + 1, steps.length - 1);
        $("summaryText") && ($("summaryText").textContent = steps[stepIndex]);
      }, 850);

      const analyzeBtn = $("analyzeBtn");
      const start = nowMs();
      const minSpin = Number(CFG.POLICY.UI_MIN_SPINNER_MS || 700);

      setReqState("Uploading‚Ä¶","warn");
      setLatency(NaN);
      hideRaw();
      $("copyJsonBtn") && ($("copyJsonBtn").disabled = true);
      $("shareBtn") && ($("shareBtn").disabled = true);
      $("caseId") && ($("caseId").textContent = "‚Äî");
      $("caseSavedHint") && ($("caseSavedHint").textContent = "Analyzing‚Ä¶");

      if (analyzeBtn){
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<i class="fa-solid fa-spinner mr-2 fa-spin"></i>Analyzing‚Ä¶';
      }

      try{
        const form = new FormData();
        form.append("file", f);
        form.append("title", $("title")?.value || "");
        form.append("platform", $("platform")?.value || "");
        form.append("country", $("country")?.value || "");
        form.append("language", $("language")?.value || "");
        form.append("tags", $("tags")?.value || "");
        form.append("notes", $("notes")?.value || "");

        const data = await upload(form);

        const elapsed = nowMs() - start;
        if (elapsed < minSpin) await sleep(minSpin - elapsed);

        setReqState("OK","good");

        if (!LS.isPro() && !LS.demoMode()){
          LS.setUsage(LS.usage() + 1);
          renderUsage();
        }

        const aiResult = data?.aiResult || data?.result || data || {};
        lastResponse = aiResult;
        renderResult(aiResult);
        showRaw(data);

        lastCaseId = data?.case_id || data?.caseId || data?.id || aiResult?.case_id || null;
        if (lastCaseId){
          $("caseId") && ($("caseId").textContent = String(lastCaseId));
          $("caseSavedHint") && ($("caseSavedHint").textContent = "Case saved.");
          $("shareBtn") && ($("shareBtn").disabled = false);
        } else {
          $("caseSavedHint") && ($("caseSavedHint").textContent = "No case id returned by backend.");
        }

        toast("Analysis complete ‚úì");
        $("resultsCard")?.scrollIntoView({ behavior:"smooth", block:"start" });
      } catch(e){
        lastErrorObj = e;
        setReqState("Failed","bad");
        $("summaryText") && ($("summaryText").textContent = `Error: ${e?.message || "Analyze failed."}`);
        toast("Analyze failed.");
        console.error("ANALYZE ERROR:", e);
      } finally {
        clearInterval(progressTimer);
        progressTimer = null;
        if (analyzeBtn){
          analyzeBtn.disabled = false;
          analyzeBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Analyze';
        }
      }
    }

    // ==========================
    // Cases
    // ==========================
    function renderSearchList(items){
      const list = $("resultsList");
      if (!list) return;
      list.innerHTML = "";

      if (!items || !items.length){
        list.innerHTML = `<div class="text-xs muted">No results.</div>`;
        return;
      }

      items.slice(0,25).forEach(item => {
        const id = item.id || item.case_id || item._id;
        const title = item?.meta?.title || item?.title || "(untitled)";
        const row = document.createElement("div");
        row.className = "chip rounded-xl p-3 mb-2 cursor-pointer hover:opacity-90";
        row.innerHTML = `
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="text-sm font-semibold truncate">${escapeHtml(title)}</div>
              <div class="text-[11px] muted mono break-all mt-1">${escapeHtml(id || "")}</div>
            </div>
            <div class="text-sm font-bold gold-text shrink-0">Load</div>
          </div>
        `;
        row.addEventListener("click", () => loadCaseById(id));
        list.appendChild(row);
      });
    }

    async function doSearch(){
      const q = ($("searchQ")?.value || "").trim();
      const tag = ($("searchTag")?.value || "").trim();
      $("resultsList") && ($("resultsList").innerHTML = `<div class="text-xs muted">Searching‚Ä¶</div>`);

      try{
        const j = await searchCases(q, tag);
        renderSearchList(j?.cases || j?.items || []);
      } catch(e){
        lastErrorObj = e;
        $("resultsList") && ($("resultsList").innerHTML = `<div class="text-xs muted">Search error. (Backend may not support /cases)</div>`);
      }
    }

    async function loadCaseById(id){
      if (!id) return;
      $("summaryText") && ($("summaryText").textContent = "Loading case‚Ä¶");
      $("resultsCard")?.scrollIntoView({ behavior:"smooth", block:"start" });

      try{
        const j = await loadCase(id);
        const c = j.case || j.item || j;
        const meta = c.meta || {};
        const data = c.data || c;

        $("title") && ($("title").value = meta.title || c.title || "");
        $("platform") && ($("platform").value = meta.platform || c.platform || "");
        $("country") && ($("country").value = meta.country || c.country || "");
        $("language") && ($("language").value = meta.language || c.language || "");
        $("tags") && ($("tags").value = Array.isArray(meta.tags) ? meta.tags.join(", ") : (meta.tags || ""));
        $("notes") && ($("notes").value = meta.notes || c.notes || "");

        lastResponse = data;
        renderResult(data);
        showRaw(j);

        lastCaseId = c.id || c._id || id;
        $("caseId") && ($("caseId").textContent = String(lastCaseId));
        $("caseSavedHint") && ($("caseSavedHint").textContent = "Loaded from saved cases.");
        $("shareBtn") && ($("shareBtn").disabled = false);

        const url = new URL(location.href);
        url.searchParams.set("case", String(lastCaseId));
        history.replaceState({}, "", url.toString());

        toast("Case loaded ‚úì");
      } catch(e){
        lastErrorObj = e;
        $("summaryText") && ($("summaryText").textContent = "Could not load case.");
        toast("Load failed.");
      }
    }

    // ==========================
    // Copy / Share / Billing
    // ==========================
    async function copyJson(){
      if (!lastResponse) { toast("No JSON yet."); return; }
      try{ await navigator.clipboard.writeText(JSON.stringify(lastResponse, null, 2)); toast("Copied ‚úì"); }
      catch{ toast("Clipboard blocked."); }
    }
    async function shareLink(){
      if (!lastCaseId) { toast("No case id."); return; }
      const url = new URL(location.href);
      url.searchParams.set("case", String(lastCaseId));
      try{ await navigator.clipboard.writeText(url.toString()); toast("Link copied ‚úì"); }
      catch{ toast(url.toString()); }
    }
    async function openBillingPortal(){
      if (CFG.STRIPE.BILLING_PORTAL_URL){
        location.href = CFG.STRIPE.BILLING_PORTAL_URL;
        return;
      }
      const customerId = LS.customerId();
      if (!customerId){ toast("No active subscription found."); return; }
      try{
        const r = await createPortal(customerId);
        if (r?.ok && r?.url) location.href = r.url;
        else toast("Could not open billing portal.");
      } catch(e){
        lastErrorObj = e;
        toast("Billing portal error.");
      }
    }

    // ==========================
    // Stripe verify ?session_id=
    // ==========================
    async function handleStripeVerify(){
      const url = new URL(location.href);
      const sessionId = url.searchParams.get("session_id");
      if (!sessionId) return;

      try{
        const data = await verifySession(sessionId);
        if (data?.ok && data?.isPro){
          localStorage.setItem("voicesafe_pro","true");
          if (data.customerId) LS.setCustomerId(data.customerId);
          toast("PRO activated ‚úì");
          renderUsage();
        } else {
          toast("Payment detected but not active yet.");
        }
      } catch(e){
        lastErrorObj = e;
        toast("Verification failed.");
      }

      url.searchParams.delete("session_id");
      history.replaceState({}, "", url.toString());
    }

    // ==========================
    // Diagnostics
    // ==========================
    async function diagRecheck(){
      $("diagBackend") && ($("diagBackend").textContent = backendBase);
      try{
        const j = await health();
        $("diagBackendHealth") && ($("diagBackendHealth").textContent = "Health OK: " + JSON.stringify(j));
      } catch(e){
        $("diagBackendHealth") && ($("diagBackendHealth").textContent = "Health FAIL: " + (e?.message || e));
      }

      $("diagLastError") && ($("diagLastError").textContent = lastErrorObj ? JSON.stringify({
        message: lastErrorObj.message,
        status: lastErrorObj.status,
        url: lastErrorObj.url,
        reqId: lastErrorObj.reqId,
        data: lastErrorObj.data
      }, null, 2) : "‚Äî");
    }

    async function diagCopy(){
      const payload = {
        mode, backendBase,
        ua: navigator.userAgent,
        time: new Date().toISOString(),
        pro: LS.isPro(),
        demo: LS.demoMode(),
        usage: LS.usage(),
        lastError: lastErrorObj ? {
          message: lastErrorObj.message,
          status: lastErrorObj.status,
          url: lastErrorObj.url,
          reqId: lastErrorObj.reqId,
          data: lastErrorObj.data
        } : null
      };
      try{ await navigator.clipboard.writeText(JSON.stringify(payload, null, 2)); toast("Diagnostics copied ‚úì"); }
      catch{ toast("Clipboard blocked."); }
    }

    function diagReset(){
      localStorage.removeItem("vs_usage");
      localStorage.removeItem("vs_demo");
      localStorage.removeItem("voicesafe_pro");
      localStorage.removeItem("voicesafe_customer_id");
      toast("Local state reset ‚úì");
      renderUsage();
      resetUI();
    }

    // ==========================
    // PWA Install
    // ==========================
    let deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      $("installBtn")?.classList.remove("hidden");
    });

    async function doInstall(){
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice.catch(()=>null);
      deferredPrompt = null;
      $("installBtn")?.classList.add("hidden");
    }

    // ==========================
    // Service worker register
    // ==========================
    async function registerSW(){
      if (!("serviceWorker" in navigator)) return;
      try{
        await navigator.serviceWorker.register("/sw.js", { scope:"/" });
      } catch {
        // ok if sw.js not present
      }
    }

    // ==========================
    // Mode set
    // ==========================
    function setMode(next){
      mode = (String(next).toUpperCase() === "LOCAL") ? "LOCAL" : "PROD";
      LS.setMode(mode);
      backendBase = CFG.URLS[mode].BACKEND.replace(/\/+$/,"");
      applyModeUI();
      toast("Mode: " + mode);
      checkHealth();
    }

    // ==========================
    // Live ticker
    // ==========================
    (function liveTicker(){
      const el = $("liveActivity");
      if (!el) return;
      const cities = ["Vienna","Warsaw","Amsterdam","Paris","Madrid","New York","Toronto","Berlin","London"];
      setInterval(() => {
        const city = cities[Math.floor(Math.random()*cities.length)];
        const seconds = Math.floor(Math.random()*40)+5;
        el.textContent = `üî• Someone from ${city} joined ${seconds}s ago`;
      }, 6500);
    })();

    // ==========================
    // Boot wiring
    // ==========================
    function boot(){
      resetUI();
      applyModeUI();
      renderUsage();
      renderWaitlist();

      $("sizeHint") && ($("sizeHint").textContent = `Max file size target: ~${CFG.POLICY.MAX_UPLOAD_MB}MB (server enforced).`);

      // Buttons
      $("btnProd")?.addEventListener("click", () => setMode("PROD"));
      $("btnLocal")?.addEventListener("click", () => setMode("LOCAL"));
      $("ctaAnalyze")?.addEventListener("click", () => $("analyzer")?.scrollIntoView({ behavior:"smooth", block:"start" }));
      $("ctaDemo")?.addEventListener("click", loadDemo);
      $("demoBtn")?.addEventListener("click", loadDemo);

      // How modal
      $("ctaHow")?.addEventListener("click", () => openModal("howModal"));
      $("howBackdrop")?.addEventListener("click", () => closeModal("howModal"));
      $("howClose")?.addEventListener("click", () => closeModal("howModal"));
      $("howTryDemo")?.addEventListener("click", () => { closeModal("howModal"); loadDemo(); });
      $("howGoAnalyze")?.addEventListener("click", () => { closeModal("howModal"); $("analyzer")?.scrollIntoView({ behavior:"smooth", block:"start" }); });

      // Waitlist / Paywall
      $("joinWaitlistBtn")?.addEventListener("click", joinWaitlist);
      $("paywallWaitlist")?.addEventListener("click", () => { joinWaitlist(); closeModal("paywallModal"); });
      $("paywallBackdrop")?.addEventListener("click", () => closeModal("paywallModal"));
      $("paywallClose")?.addEventListener("click", () => closeModal("paywallModal"));
      $("paywallCta")?.addEventListener("click", () => location.href = CFG.STRIPE.CHECKOUT_URL);

      // Stripe
      $("upgradeBtn")?.addEventListener("click", () => location.href = CFG.STRIPE.CHECKOUT_URL);
      $("manageSubBtn")?.addEventListener("click", openBillingPortal);

      // Copy/share
      $("copyJsonBtn")?.addEventListener("click", copyJson);
      $("shareBtn")?.addEventListener("click", shareLink);

      // Analyzer
      $("recordBtn")?.addEventListener("click", toggleRecord);
      $("analyzeBtn")?.addEventListener("click", analyze);

      $("fileInput")?.addEventListener("change", () => {
        const f = $("fileInput").files?.[0];
        $("fileHint") && ($("fileHint").textContent = f ? `Selected: ${f.name} (${Math.round(f.size / 1024)} KB)` : "No file selected.");
        updateAnalyzeEnabled();
      });

      // Cases
      $("searchBtn")?.addEventListener("click", doSearch);
      $("clearBtn")?.addEventListener("click", () => {
        $("searchQ") && ($("searchQ").value = "");
        $("searchTag") && ($("searchTag").value = "");
        $("resultsList") && ($("resultsList").innerHTML = "");
        toast("Cleared.");
      });

      // Diagnostics
      $("diagBackdrop")?.addEventListener("click", () => closeModal("diagModal"));
      $("diagClose")?.addEventListener("click", () => closeModal("diagModal"));
      $("diagRecheck")?.addEventListener("click", diagRecheck);
      $("diagCopy")?.addEventListener("click", diagCopy);
      $("diagReset")?.addEventListener("click", diagReset);

      // Install
      $("installBtn")?.addEventListener("click", doInstall);

      // Keyboard
      document.addEventListener("keydown", (e) => {
        const k = (e.key || "").toLowerCase();
        if (k === "d") loadDemo();
        if (k === "?") { openModal("diagModal"); diagRecheck(); }
      });

      // Auto-load share ?case=
      (function bootCase(){
        const u = new URL(location.href);
        const id = u.searchParams.get("case");
        if (id) loadCaseById(id);
      })();

      // Quick demo via URL ?demo=true
      (function bootDemo(){
        const u = new URL(location.href);
        if (u.searchParams.get("demo") === "true") loadDemo();
      })();

      updateAnalyzeEnabled();
      checkHealth();
      handleStripeVerify();
      registerSW();
    }

    boot();
  })();
  </script>
</body>
</html>